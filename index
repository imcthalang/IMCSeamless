<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ Intermediate Care</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script><!-- Thailand.js dependencies -->
  <script src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dependencies/JQL.min.js"></script>
  <script src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dependencies/typeahead.bundle.js"></script>
  <script src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dist/jquery.Thailand.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .section-divider {
      border-top: 2px solid #e2e8f0;
      margin: 2rem 0;
    }

    /* Typeahead autocomplete styles */
    .twitter-typeahead {
      width: 100% !important;
      display: block !important;
    }
    
    .tt-menu {
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background-color: white;
      border: 2px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 0.5rem 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    
    .tt-suggestion {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .tt-suggestion:hover,
    .tt-suggestion.tt-cursor {
      background-color: #3b82f6;
      color: white;
    }
    
    .tt-suggestion:last-child {
      border-bottom: none;
    }

    .tt-hint {
      color: #999;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="w-full min-h-full">
  <div id="app" class="w-full min-h-full"></div>
  <script>
    const defaultConfig = {
      background_color: "#f0f4f8",
      surface_color: "#ffffff",
      text_color: "#1e293b",
      primary_action: "#3b82f6",
      secondary_action: "#64748b",
      font_family: "Sarabun",
      font_size: 16,
      app_title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ Intermediate Care",
      patient_list_title: "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢",
      add_patient_button: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà"
    };

    let allData = [];
    let currentView = 'list';
    let selectedPatientId = null;
    let editingRecord = null;

    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        render();
      }
    };

    async function initApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Failed to initialize data SDK");
        return;
      }

      await window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });

      render();
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.surface_color || defaultConfig.surface_color,
            set: (value) => {
              config.surface_color = value;
              window.elementSdk.setConfig({ surface_color: value });
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              window.elementSdk.setConfig({ text_color: value });
            }
          },
          {
            get: () => config.primary_action || defaultConfig.primary_action,
            set: (value) => {
              config.primary_action = value;
              window.elementSdk.setConfig({ primary_action: value });
            }
          },
          {
            get: () => config.secondary_action || defaultConfig.secondary_action,
            set: (value) => {
              config.secondary_action = value;
              window.elementSdk.setConfig({ secondary_action: value });
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            config.font_family = value;
            window.elementSdk.setConfig({ font_family: value });
          }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => {
            config.font_size = value;
            window.elementSdk.setConfig({ font_size: value });
          }
        }
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["app_title", config.app_title || defaultConfig.app_title],
        ["patient_list_title", config.patient_list_title || defaultConfig.patient_list_title],
        ["add_patient_button", config.add_patient_button || defaultConfig.add_patient_button]
      ]);
    }

    async function onConfigChange(config) {
      const app = document.getElementById('app');
      if (!app) return;

      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action || defaultConfig.primary_action;
      const secondaryColor = config.secondary_action || defaultConfig.secondary_action;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;

      app.style.backgroundColor = bgColor;
      app.style.color = textColor;
      app.style.fontFamily = `${fontFamily}, 'Segoe UI', sans-serif`;
      app.style.fontSize = `${fontSize}px`;

      const headers = app.querySelectorAll('h1, h2, h3, h4');
      headers.forEach(h => {
        h.style.color = textColor;
        h.style.fontFamily = `${fontFamily}, 'Segoe UI', sans-serif`;
        if (h.tagName === 'H1') h.style.fontSize = `${fontSize * 2}px`;
        if (h.tagName === 'H2') h.style.fontSize = `${fontSize * 1.5}px`;
        if (h.tagName === 'H3') h.style.fontSize = `${fontSize * 1.25}px`;
        if (h.tagName === 'H4') h.style.fontSize = `${fontSize * 1.1}px`;
      });

      const cards = app.querySelectorAll('.card, .surface');
      cards.forEach(card => {
        card.style.backgroundColor = surfaceColor;
        card.style.color = textColor;
      });

      const primaryButtons = app.querySelectorAll('.btn-primary');
      primaryButtons.forEach(btn => {
        btn.style.backgroundColor = primaryColor;
        btn.style.color = '#ffffff';
      });

      const secondaryButtons = app.querySelectorAll('.btn-secondary');
      secondaryButtons.forEach(btn => {
        btn.style.backgroundColor = secondaryColor;
        btn.style.color = '#ffffff';
      });

      const labels = app.querySelectorAll('label, .text-sm');
      labels.forEach(label => {
        label.style.color = textColor;
        label.style.fontSize = `${fontSize * 0.875}px`;
      });

      const appTitleEl = app.querySelector('#app-title');
      if (appTitleEl) {
        appTitleEl.textContent = config.app_title || defaultConfig.app_title;
      }

      const patientListTitleEl = app.querySelector('#patient-list-title');
      if (patientListTitleEl) {
        patientListTitleEl.textContent = config.patient_list_title || defaultConfig.patient_list_title;
      }

      const addPatientBtnEl = app.querySelector('#add-patient-btn');
      if (addPatientBtnEl) {
        addPatientBtnEl.textContent = config.add_patient_button || defaultConfig.add_patient_button;
      }
    }

    function initThailandAutocomplete() {
      setTimeout(() => {
        if (typeof $.Thailand !== 'undefined') {
          $.Thailand({
            database: 'https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/database/db.json',
            $district: $('#subdistrict'),
            $amphoe: $('#district'), 
            $province: $('#province'),
            $zipcode: $('#zipcode'),
            onDataFill: function(data) {
              console.log('Thailand.js filled:', data);
            }
          });
        }
      }, 150);
    }

    function setAddressFields(patient) {
      if (!patient) return;

      setTimeout(() => {
        const subdistrictInput = document.getElementById('subdistrict');
        const districtInput = document.getElementById('district');
        const provinceInput = document.getElementById('province');
        const zipcodeInput = document.getElementById('zipcode');
        const houseNumberInput = document.getElementById('houseNumber');
        const mooInput = document.getElementById('moo');

        if (houseNumberInput && patient.houseNumber) {
          houseNumberInput.value = patient.houseNumber;
        }
        if (mooInput && patient.moo) {
          mooInput.value = patient.moo;
        }
        if (subdistrictInput && patient.subdistrict) {
          subdistrictInput.value = patient.subdistrict;
        }
        if (districtInput && patient.district) {
          districtInput.value = patient.district;
        }
        if (provinceInput && patient.province) {
          provinceInput.value = patient.province;
        }
        if (zipcodeInput && patient.zipcode) {
          zipcodeInput.value = patient.zipcode;
        }

        initThailandAutocomplete();
      }, 200);
    }

    function render() {
      const app = document.getElementById('app');
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;

      if (currentView === 'list') {
        app.innerHTML = renderPatientList();
      } else if (currentView === 'patient-detail') {
        app.innerHTML = renderPatientDetail();
      } else if (currentView === 'add-patient') {
        app.innerHTML = renderPatientForm('add');
        initThailandAutocomplete();
      } else if (currentView === 'edit-patient') {
        app.innerHTML = renderPatientForm('edit');
        const patient = allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId);
        setAddressFields(patient);
      } else if (currentView === 'add-assessment') {
        app.innerHTML = renderAssessmentForm('add');
      } else if (currentView === 'edit-assessment') {
        app.innerHTML = renderAssessmentForm('edit');
      }

      onConfigChange(config);
    }

    function getFullAddress(patient) {
      const parts = [];
      if (patient.houseNumber) parts.push(patient.houseNumber);
      if (patient.moo) parts.push(`‡∏´‡∏°‡∏π‡πà ${patient.moo}`);
      if (patient.subdistrict) parts.push(`‡∏ï.${patient.subdistrict}`);
      if (patient.district) parts.push(`‡∏≠.${patient.district}`);
      if (patient.province) parts.push(`‡∏à.${patient.province}`);
      if (patient.zipcode) parts.push(patient.zipcode);
      return parts.length > 0 ? parts.join(' ') : '-';
    }

    function renderPatientList() {
      const patients = allData.filter(d => d.type === 'patient');
      
      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-8">
              <h1 id="app-title" class="text-4xl font-bold">${defaultConfig.app_title}</h1>
              <button id="add-patient-btn" onclick="showAddPatient()" class="btn-primary px-6 py-3 rounded-lg font-semibold transition-all">
                ${defaultConfig.add_patient_button}
              </button>
            </div>

            <div class="surface rounded-xl shadow-lg p-6">
              <h2 id="patient-list-title" class="text-2xl font-semibold mb-6">${defaultConfig.patient_list_title}</h2>
              
              ${patients.length === 0 ? `
                <div class="text-center py-12">
                  <p class="text-xl opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
                  <p class="mt-2 opacity-50">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</p>
                </div>
              ` : `
                <div class="space-y-4">
                  ${patients.map(patient => `
                    <div class="card card-hover p-5 rounded-lg border-2 border-gray-200 cursor-pointer transition-all" onclick="showPatientDetail('${patient.patientId}')">
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <h3 class="text-xl font-semibold mb-3">${patient.firstName} ${patient.lastName}</h3>
                          <div class="grid grid-cols-3 gap-x-6 gap-y-2 text-sm opacity-75">
                            <p><strong>HN:</strong> ${patient.hn}</p>
                            <p><strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${patient.age} ‡∏õ‡∏µ</p>
                            <p><strong>‡πÄ‡∏û‡∏®:</strong> ${patient.gender}</p>
                            <p><strong>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</strong> ${patient.medicalRights || '-'}</p>
                            <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${patient.phoneNumber || '-'}</p>
                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤ IMC:</strong> ${formatThaiDate(patient.imcAdmitDate)}</p>
                          </div>
                          <p class="mt-3 text-sm"><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${getFullAddress(patient)}</p>
                          ${patient.diagnosisDetails ? `<p class="mt-2 text-sm"><strong>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢:</strong> ${patient.diagnosisDetails}</p>` : ''}
                        </div>
                        <div class="flex gap-2 ml-4">
                          <button onclick="event.stopPropagation(); showEditPatient('${patient.patientId}')" class="btn-secondary px-4 py-2 rounded text-sm font-semibold">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                          </button>
                          <button onclick="event.stopPropagation(); deletePatient('${patient.patientId}')" class="bg-red-500 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-red-600">
                            ‡∏•‡∏ö
                          </button>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderPatientDetail() {
      const patient = allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId);
      if (!patient) {
        currentView = 'list';
        render();
        return '';
      }

      const assessments = allData.filter(d => d.type === 'assessment' && d.patientId === selectedPatientId)
        .sort((a, b) => new Date(b.assessmentDate) - new Date(a.assessmentDate));

      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-7xl mx-auto">
            <button onclick="backToList()" class="btn-secondary px-4 py-2 rounded-lg mb-6 font-semibold">
              ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
            </button>

            <div class="surface rounded-xl shadow-lg p-6 mb-6">
              <div class="flex justify-between items-start mb-6">
                <h2 class="text-3xl font-bold">${patient.firstName} ${patient.lastName}</h2>
                <button onclick="showEditPatient('${patient.patientId}')" class="btn-secondary px-5 py-2 rounded-lg font-semibold">
                  ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
              </div>

              <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
              <h4 class="text-lg font-semibold mb-3 text-blue-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h4>
              <div class="grid grid-cols-3 gap-x-8 gap-y-3 mb-4">
                <p><strong>HN:</strong> ${patient.hn}</p>
                <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> ${patient.nationalId || '-'}</p>
                <p><strong>‡πÄ‡∏û‡∏®:</strong> ${patient.gender}</p>
                <p><strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${patient.age} ‡∏õ‡∏µ</p>
                <p><strong>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</strong> ${patient.medicalRights || '-'}</p>
                <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> ${patient.phoneNumber || '-'}</p>
                <p class="col-span-3"><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${getFullAddress(patient)}</p>
              </div>
              
              ${patient.gpsCoordinates ? `
                <div class="mb-4">
                  <p class="font-semibold mb-2">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${patient.gpsCoordinates}</p>
                  <div class="rounded-lg overflow-hidden">
                    <iframe src="https://maps.google.com/maps?q=${patient.gpsCoordinates}&z=15&output=embed" 
                      width="100%" height="300" frameborder="0" style="border:0" allowfullscreen></iframe>
                  </div>
                </div>
              ` : ''}

              <div class="section-divider"></div>

              <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢ -->
              <h4 class="text-lg font-semibold mb-3 text-blue-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢</h4>
              <div class="grid grid-cols-2 gap-x-8 gap-y-3 mb-4">
                <p><strong>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</strong> ${patient.underlyingDiseases || '-'}</p>
                <p><strong>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ:</strong> ${patient.diagnosisDetails || '-'}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô:</strong> ${formatThaiDate(patient.onsetDate) || '-'}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Admit:</strong> ${formatThaiDate(patient.admitDate) || '-'}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤ IMC:</strong> ${formatThaiDate(patient.imcAdmitDate)}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢:</strong> ${formatThaiDate(patient.dischargeDate) || '-'}</p>
              </div>
              
              ${patient.labResults ? `
                <div class="mb-3">
                  <p class="font-semibold mb-1">‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£:</p>
                  <p class="text-sm bg-gray-50 p-3 rounded">${patient.labResults}</p>
                </div>
              ` : ''}

              ${patient.additionalNotes ? `
                <div>
                  <p class="font-semibold mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</p>
                  <p class="text-sm bg-gray-50 p-3 rounded">${patient.additionalNotes}</p>
                </div>
              ` : ''}
            </div>

            <div class="surface rounded-xl shadow-lg p-6">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•</h3>
                <button onclick="showAddAssessment()" class="btn-primary px-6 py-3 rounded-lg font-semibold">
                  + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                </button>
              </div>

              ${assessments.length === 0 ? `
                <div class="text-center py-12">
                  <p class="text-xl opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•</p>
                  <p class="mt-2 opacity-50">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
                </div>
              ` : `
                <div class="space-y-4">
                  ${assessments.map(assessment => `
                    <div class="card p-5 rounded-lg border-2 border-gray-200">
                      <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                          <p class="text-lg font-semibold mb-3">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: ${formatThaiDate(assessment.assessmentDate)}</p>
                          <div class="grid grid-cols-1 gap-4">
                            <div class="bg-blue-50 p-3 rounded">
                              <p class="font-semibold text-sm opacity-75 mb-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô BI (Barthel Index):</p>
                              <p class="text-2xl font-bold text-blue-600">${assessment.biScore} / 100</p>
                              ${assessment.biDetails ? `<p class="text-sm mt-2">${assessment.biDetails}</p>` : ''}
                            </div>
                            <div>
                              <p class="font-semibold text-sm opacity-75 mb-1">PT Assessment:</p>
                              <p class="text-sm whitespace-pre-line">${assessment.ptAssessment || '-'}</p>
                            </div>
                            <div>
                              <p class="font-semibold text-sm opacity-75 mb-1">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</p>
                              <p class="text-sm whitespace-pre-line">${assessment.ptGoals || '-'}</p>
                            </div>
                            ${assessment.notes ? `
                              <div>
                                <p class="font-semibold text-sm opacity-75 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</p>
                                <p class="text-sm whitespace-pre-line bg-yellow-50 p-2 rounded">${assessment.notes}</p>
                              </div>
                            ` : ''}
                          </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                          <button onclick="showEditAssessment('${assessment.__backendId}')" class="btn-secondary px-4 py-2 rounded text-sm font-semibold">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                          </button>
                          <button onclick="deleteAssessment('${assessment.__backendId}')" class="bg-red-500 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-red-600">
                            ‡∏•‡∏ö
                          </button>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderPatientForm(mode) {
      const isEdit = mode === 'edit';
      const patient = isEdit ? allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId) : null;

      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-5xl mx-auto">
            <button onclick="${isEdit ? `showPatientDetail('${selectedPatientId}')` : 'backToList()'}" class="btn-secondary px-4 py-2 rounded-lg mb-6 font-semibold">
              ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            </button>

            <div class="surface rounded-xl shadow-lg p-8">
              <h2 class="text-3xl font-bold mb-8">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà'}</h2>

              <form id="patient-form" onsubmit="savePatient(event, '${mode}')">
                
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
                <h3 class="text-xl font-semibold mb-4 text-blue-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                <div class="space-y-4 mb-6">
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label for="firstName" class="block font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠ *</label>
                      <input type="text" id="firstName" name="firstName" value="${isEdit ? patient.firstName : ''}" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="lastName" class="block font-semibold mb-2">‡∏™‡∏Å‡∏∏‡∏• *</label>
                      <input type="text" id="lastName" name="lastName" value="${isEdit ? patient.lastName : ''}" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div class="grid grid-cols-3 gap-4">
                    <div>
                      <label for="hn" class="block font-semibold mb-2">HN *</label>
                      <input type="text" id="hn" name="hn" value="${isEdit ? patient.hn : ''}" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="nationalId" class="block font-semibold mb-2">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                      <input type="text" id="nationalId" name="nationalId" value="${isEdit ? patient.nationalId || '' : ''}" maxlength="13"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="gender" class="block font-semibold mb-2">‡πÄ‡∏û‡∏® *</label>
                      <select id="gender" name="gender" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®</option>
                        <option value="‡∏ä‡∏≤‡∏¢" ${isEdit && patient.gender === '‡∏ä‡∏≤‡∏¢' ? 'selected' : ''}>‡∏ä‡∏≤‡∏¢</option>
                        <option value="‡∏´‡∏ç‡∏¥‡∏á" ${isEdit && patient.gender === '‡∏´‡∏ç‡∏¥‡∏á' ? 'selected' : ''}>‡∏´‡∏ç‡∏¥‡∏á</option>
                      </select>
                    </div>
                  </div>

                  <div class="grid grid-cols-3 gap-4">
                    <div>
                      <label for="age" class="block font-semibold mb-2">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ) *</label>
                      <input type="number" id="age" name="age" value="${isEdit ? patient.age : ''}" required min="0" max="150"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="phoneNumber" class="block font-semibold mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                      <input type="tel" id="phoneNumber" name="phoneNumber" value="${isEdit ? patient.phoneNumber || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="medicalRights" class="block font-semibold mb-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                      <input type="text" id="medicalRights" name="medicalRights" value="${isEdit ? patient.medicalRights || '' : ''}"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div>
                    <label class="block font-semibold mb-3">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                    <div class="space-y-3">
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <label for="houseNumber" class="block text-sm font-semibold mb-1">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏ã‡∏≠‡∏¢ / ‡∏ñ‡∏ô‡∏ô</label>
                          <input type="text" id="houseNumber" name="houseNumber" 
                            value="${isEdit ? patient.houseNumber || '' : ''}"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô 123 ‡∏ã‡∏≠‡∏¢‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó 21"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                          <label for="moo" class="block text-sm font-semibold mb-1">‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</label>
                          <input type="text" id="moo" name="moo" 
                            value="${isEdit ? patient.moo || '' : ''}"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô 5"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                      </div>
                      <div class="grid grid-cols-4 gap-4">
                        <div>
                          <label for="subdistrict" class="block text-sm font-semibold mb-1">‡∏ï‡∏≥‡∏ö‡∏•</label>
                          <input type="text" id="subdistrict" name="subdistrict"
                            value="${isEdit ? patient.subdistrict || '' : ''}"
                            placeholder="‡∏ï‡∏≥‡∏ö‡∏•"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                          <label for="district" class="block text-sm font-semibold mb-1">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
                          <input type="text" id="district" name="district"
                            value="${isEdit ? patient.district || '' : ''}"
                            placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                          <label for="province" class="block text-sm font-semibold mb-1">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                          <input type="text" id="province" name="province"
                            value="${isEdit ? patient.province || '' : ''}"
                            placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                          <label for="zipcode" class="block text-sm font-semibold mb-1">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                          <input type="text" id="zipcode" name="zipcode"
                            value="${isEdit ? patient.zipcode || '' : ''}"
                            placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå"
                            maxlength="5"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                      </div>
                    </div>
                  </div>

                  <div>
                    <label for="gpsCoordinates" class="block font-semibold mb-2">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                    <input type="text" id="gpsCoordinates" name="gpsCoordinates" value="${isEdit ? patient.gpsCoordinates || '' : ''}"
                      placeholder="‡πÄ‡∏ä‡πà‡∏ô 13.7563, 100.5018"
                      oninput="updateMap()"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    <div id="map-preview" class="mt-2 rounded-lg overflow-hidden" style="display: none;">
                      <iframe id="map-iframe" width="100%" height="300" frameborder="0" style="border:0" allowfullscreen></iframe>
                    </div>
                  </div>
                </div>

                <div class="section-divider"></div>

                <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢ -->
                <h3 class="text-xl font-semibold mb-4 text-blue-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢</h3>
                <div class="space-y-4 mb-6">
                  <div>
                    <label class="block font-semibold mb-3">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                    <div class="grid grid-cols-3 gap-4">
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="HT" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('HT') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>HT (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="DM" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('DM') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>DM (‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="DLP" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('DLP') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>DLP (‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="CKD" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('CKD') ? 'checked' : ''}
                          class="w-full h-5 rounded border-gray-300 focus:ring-2">
                        <span>CKD (‡πÑ‡∏ï‡∏ß‡∏≤‡∏¢)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="Heart disease" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('Heart disease') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>Heart disease (‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à)</span>
                      </label>
                    </div>
                    <div class="mt-3">
                      <label for="otherDiseases" class="block text-sm font-semibold mb-1">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</label>
                      <input type="text" id="otherDiseases" name="otherDiseases" 
                        value="${isEdit && patient.underlyingDiseases ? patient.underlyingDiseases.split(',').filter(d => !['HT', 'DM', 'DLP', 'CKD', 'Heart disease'].includes(d.trim())).join(', ') : ''}"
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏Ñ‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div>
                    <label class="block font-semibold mb-3">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ</label>
                    <div class="space-y-4">
                      <!-- Stroke -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer mb-3">
                          <input type="checkbox" id="diagnosis-stroke" name="diagnosis" value="Stroke" 
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Stroke') ? 'checked' : ''}
                            onchange="toggleStrokeDetails(this.checked)"
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">Stroke</span>
                        </label>
                        <div id="stroke-details" class="ml-7 space-y-2" style="display: ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Stroke') ? 'block' : 'none'}">
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="stroke_type" value="Ischemic stroke"
                              ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Ischemic stroke') ? 'checked' : ''}
                              class="w-4 h-4">
                            <span class="text-sm">Ischemic stroke</span>
                          </label>
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="stroke_type" value="Hemorrhagic stroke"
                              ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Hemorrhagic stroke') ? 'checked' : ''}
                              class="w-4 h-4">
                            <span class="text-sm">Hemorrhagic stroke</span>
                          </label>
                        </div>
                      </div>

                      <!-- TBI -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" name="diagnosis" value="TBI"
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('TBI') ? 'checked' : ''}
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">TBI (Traumatic Brain Injury)</span>
                        </label>
                      </div>

                      <!-- SCI -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" name="diagnosis" value="SCI"
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('SCI') ? 'checked' : ''}
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">SCI (Spinal Cord Injury)</span>
                        </label>
                      </div>

                      <!-- Hip fracture -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer mb-3">
                          <input type="checkbox" id="diagnosis-hip" name="diagnosis" value="Hip fracture"
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Hip fracture') ? 'checked' : ''}
                            onchange="toggleHipDetails(this.checked)"
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">Hip fracture</span>
                        </label>
                        <div id="hip-details" class="ml-7 space-y-3" style="display: ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Hip fracture') ? 'block' : 'none'}">
                          <div>
                            <p class="text-sm font-semibold mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</p>
                            <div class="space-y-2">
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_location" value="Neck of femur"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Neck of femur') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Neck of femur</span>
                              </label>
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_location" value="Intertrochanter"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Intertrochanter') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Intertrochanter</span>
                              </label>
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_location" value="Subtrochanter"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Subtrochanter') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Subtrochanter</span>
                              </label>
                            </div>
                          </div>
                          <div>
                            <p class="text-sm font-semibold mb-2">‡∏Ç‡πâ‡∏≤‡∏á:</p>
                            <div class="flex gap-4">
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_side" value="Lt"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Lt') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Lt. (‡∏ã‡πâ‡∏≤‡∏¢)</span>
                              </label>
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_side" value="Rt"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Rt') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Rt. (‡∏Ç‡∏ß‡∏≤)</span>
                              </label>
                            </div>
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label for="onsetDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô</label>
                      <input type="date" id="onsetDate" name="onsetDate" value="${isEdit ? patient.onsetDate || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="admitDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Admit</label>
                      <input type="date" id="admitDate" name="admitDate" value="${isEdit ? patient.admitDate || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label for="imcAdmitDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤ IMC *</label>
                      <input type="date" id="imcAdmitDate" name="imcAdmitDate" value="${isEdit ? patient.imcAdmitDate : ''}" required
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="dischargeDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô</label>
                      <input type="date" id="dischargeDate" name="dischargeDate" value="${isEdit ? patient.dischargeDate || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div>
                    <label for="labResults" class="block font-semibold mb-2">‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</label>
                    <textarea id="labResults" name="labResults" rows="3" 
                      placeholder="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? patient.labResults || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="additionalNotes" class="block font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="additionalNotes" name="additionalNotes" rows="3" 
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? patient.additionalNotes || '' : ''}</textarea>
                  </div>
                </div>

                <div class="flex justify-end gap-4 mt-8">
                  <button type="button" onclick="${isEdit ? `showPatientDetail('${selectedPatientId}')` : 'backToList()'}" 
                    class="btn-secondary px-6 py-3 rounded-lg font-semibold">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                  </button>
                  <button type="submit" id="submit-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                    <span id="submit-text">${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'}</span>
                    <span id="submit-spinner" class="loading-spinner hidden"></span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    function renderAssessmentForm(mode) {
      const isEdit = mode === 'edit';
      const assessment = isEdit ? allData.find(d => d.__backendId === editingRecord) : null;

      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-4xl mx-auto">
            <button onclick="showPatientDetail('${selectedPatientId}')" class="btn-secondary px-4 py-2 rounded-lg mb-6 font-semibold">
              ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            </button>

            <div class="surface rounded-xl shadow-lg p-8">
              <h2 class="text-3xl font-bold mb-6">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà'}</h2>

              <form id="assessment-form" onsubmit="saveAssessment(event, '${mode}')">
                <div class="space-y-4">
                  <div>
                    <label for="assessmentDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô *</label>
                    <input type="date" id="assessmentDate" name="assessmentDate" 
                      value="${isEdit ? assessment.assessmentDate : ''}" required 
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                  </div>

                  <div>
                    <label for="biScore" class="block font-semibold mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô BI (Barthel Index) * (0-100)</label>
                    <input type="number" id="biScore" name="biScore" min="0" max="100" 
                      value="${isEdit ? assessment.biScore : ''}" required 
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                  </div>

                  <div>
                    <label for="biDetails" class="block font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î BI</label>
                    <textarea id="biDetails" name="biDetails" rows="3" 
                      placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.biDetails || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="ptAssessment" class="block font-semibold mb-2">PT Assessment</label>
                    <textarea id="ptAssessment" name="ptAssessment" rows="4" 
                      placeholder="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.ptAssessment || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="ptGoals" class="block font-semibold mb-2">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                    <textarea id="ptGoals" name="ptGoals" rows="3" 
                      placeholder="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.ptGoals || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="notes" class="block font-semibold mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="notes" name="notes" rows="3" 
                      placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.notes || '' : ''}</textarea>
                  </div>

                  <div class="flex justify-end gap-4 mt-8">
                    <button type="button" onclick="showPatientDetail('${selectedPatientId}')" 
                      class="btn-secondary px-6 py-3 rounded-lg font-semibold">
                      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" id="submit-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                      <span id="submit-text">${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'}</span>
                      <span id="submit-spinner" class="loading-spinner hidden"></span>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    function toggleStrokeDetails(checked) {
      const strokeDetails = document.getElementById('stroke-details');
      if (strokeDetails) {
        strokeDetails.style.display = checked ? 'block' : 'none';
      }
    }

    function toggleHipDetails(checked) {
      const hipDetails = document.getElementById('hip-details');
      if (hipDetails) {
        hipDetails.style.display = checked ? 'block' : 'none';
      }
    }

    function updateMap() {
      const gpsInput = document.getElementById('gpsCoordinates');
      const mapPreview = document.getElementById('map-preview');
      const mapIframe = document.getElementById('map-iframe');
      
      if (!gpsInput || !mapPreview || !mapIframe) return;
      
      const coords = gpsInput.value.trim();
      if (coords && coords.includes(',')) {
        const [lat, lng] = coords.split(',').map(c => c.trim());
        if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
          mapIframe.src = `https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed`;
          mapPreview.style.display = 'block';
        } else {
          mapPreview.style.display = 'none';
        }
      } else {
        mapPreview.style.display = 'none';
      }
    }
    
    setTimeout(() => {
      updateMap();
    }, 100);

    function showAddPatient() {
      if (allData.filter(d => d.type === 'patient').length >= 999) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢');
        return;
      }
      currentView = 'add-patient';
      render();
    }

    function showEditPatient(patientId) {
      selectedPatientId = patientId;
      currentView = 'edit-patient';
      render();
    }

    function showPatientDetail(patientId) {
      selectedPatientId = patientId;
      currentView = 'patient-detail';
      render();
    }

    function showAddAssessment() {
      if (allData.length >= 999) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return;
      }
      currentView = 'add-assessment';
      render();
    }

    function showEditAssessment(backendId) {
      editingRecord = backendId;
      currentView = 'edit-assessment';
      render();
    }

    function backToList() {
      selectedPatientId = null;
      currentView = 'list';
      render();
    }

    async function savePatient(event, mode) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');
      
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-disabled');
      submitText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      submitSpinner.classList.remove('hidden');

      const formData = new FormData(event.target);
      
      // ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß
      const diseases = [];
      const diseaseCheckboxes = event.target.querySelectorAll('input[name="disease"]:checked');
      diseaseCheckboxes.forEach(cb => diseases.push(cb.value));
      const otherDiseases = formData.get('otherDiseases');
      if (otherDiseases && otherDiseases.trim()) {
        diseases.push(otherDiseases.trim());
      }
      
      // ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ
      const diagnosisParts = [];
      const diagnosisCheckboxes = event.target.querySelectorAll('input[name="diagnosis"]:checked');
      diagnosisCheckboxes.forEach(cb => {
        const value = cb.value;
        diagnosisParts.push(value);
        
        if (value === 'Stroke') {
          const strokeType = event.target.querySelector('input[name="stroke_type"]:checked');
          if (strokeType) {
            diagnosisParts.push(strokeType.value);
          }
        }
        
        if (value === 'Hip fracture') {
          const hipLocation = event.target.querySelector('input[name="hip_location"]:checked');
          if (hipLocation) {
            diagnosisParts.push(hipLocation.value);
          }
          const hipSide = event.target.querySelector('input[name="hip_side"]:checked');
          if (hipSide) {
            diagnosisParts.push(hipSide.value);
          }
        }
      });
      
      const patientData = {
        type: 'patient',
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        hn: formData.get('hn'),
        nationalId: formData.get('nationalId') || null,
        birthDate: null,
        age: parseInt(formData.get('age')),
        gender: formData.get('gender'),
        medicalRights: formData.get('medicalRights') || null,
        houseNumber: formData.get('houseNumber') || null,
        moo: formData.get('moo') || null,
        subdistrict: formData.get('subdistrict') || null,
        district: formData.get('district') || null,
        province: formData.get('province') || null,
        zipcode: formData.get('zipcode') || null,
        gpsCoordinates: formData.get('gpsCoordinates') || null,
        phoneNumber: formData.get('phoneNumber') || null,
        underlyingDiseases: diseases.length > 0 ? diseases.join(', ') : null,
        diagnosisDetails: diagnosisParts.length > 0 ? diagnosisParts.join(' | ') : null,
        onsetDate: formData.get('onsetDate') || null,
        admitDate: formData.get('admitDate') || null,
        imcAdmitDate: formData.get('imcAdmitDate'),
        dischargeDate: formData.get('dischargeDate') || null,
        labResults: formData.get('labResults') || null,
        additionalNotes: formData.get('additionalNotes') || null,
        createdAt: new Date().toISOString()
      };

      let result;
      if (mode === 'add') {
        if (allData.filter(d => d.type === 'patient').length >= 999) {
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢');
          submitBtn.disabled = false;
          submitBtn.classList.remove('btn-disabled');
          submitText.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢';
          submitSpinner.classList.add('hidden');
          return;
        }
        patientData.patientId = 'P' + Date.now();
        result = await window.dataSdk.create(patientData);
      } else {
        const existing = allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId);
        result = await window.dataSdk.update({ ...existing, ...patientData });
      }

      submitBtn.disabled = false;
      submitBtn.classList.remove('btn-disabled');
      submitSpinner.classList.add('hidden');

      if (result.isOk) {
        showToast(mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        if (mode === 'add') {
          backToList();
        } else {
          showPatientDetail(selectedPatientId);
        }
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
        submitText.textContent = mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
      }
    }

    async function saveAssessment(event, mode) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');
      
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-disabled');
      submitText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      submitSpinner.classList.remove('hidden');

      const formData = new FormData(event.target);
      const assessmentData = {
        type: 'assessment',
        patientId: selectedPatientId,
        assessmentDate: formData.get('assessmentDate'),
        biScore: parseInt(formData.get('biScore')),
        biDetails: formData.get('biDetails') || null,
        ptAssessment: formData.get('ptAssessment') || null,
        ptGoals: formData.get('ptGoals') || null,
        notes: formData.get('notes') || null,
        createdAt: new Date().toISOString()
      };

      let result;
      if (mode === 'add') {
        if (allData.length >= 999) {
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
          submitBtn.disabled = false;
          submitBtn.classList.remove('btn-disabled');
          submitText.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô';
          submitSpinner.classList.add('hidden');
          return;
        }
        result = await window.dataSdk.create(assessmentData);
      } else {
        const existing = allData.find(d => d.__backendId === editingRecord);
        result = await window.dataSdk.update({ ...existing, ...assessmentData });
      }

      submitBtn.disabled = false;
      submitBtn.classList.remove('btn-disabled');
      submitSpinner.classList.add('hidden');

      if (result.isOk) {
        showToast(mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        showPatientDetail(selectedPatientId);
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
        submitText.textContent = mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
      }
    }

    async function deletePatient(patientId) {
      const patient = allData.find(d => d.type === 'patient' && d.patientId === patientId);
      if (!patient) return;

      const assessments = allData.filter(d => d.type === 'assessment' && d.patientId === patientId);
      
      const confirmEl = document.createElement('div');
      confirmEl.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
      confirmEl.innerHTML = `
        <div class="surface rounded-xl shadow-2xl p-8 max-w-md mx-4">
          <h3 class="text-2xl font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
          <p class="mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ "${patient.firstName} ${patient.lastName}" ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${assessments.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
          <div class="flex gap-4 justify-end">
            <button id="cancel-delete" class="btn-secondary px-6 py-3 rounded-lg font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button id="confirm-delete" class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 flex items-center gap-2">
              <span id="delete-text">‡∏•‡∏ö</span>
              <span id="delete-spinner" class="loading-spinner hidden"></span>
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmEl);

      document.getElementById('cancel-delete').onclick = () => {
        document.body.removeChild(confirmEl);
      };

      document.getElementById('confirm-delete').onclick = async () => {
        const deleteBtn = document.getElementById('confirm-delete');
        const deleteText = document.getElementById('delete-text');
        const deleteSpinner = document.getElementById('delete-spinner');
        
        deleteBtn.disabled = true;
        deleteBtn.classList.add('btn-disabled');
        deleteText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
        deleteSpinner.classList.remove('hidden');

        for (const assessment of assessments) {
          await window.dataSdk.delete(assessment);
        }
        
        const result = await window.dataSdk.delete(patient);
        
        if (result.isOk) {
          showToast('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          document.body.removeChild(confirmEl);
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
          deleteBtn.disabled = false;
          deleteBtn.classList.remove('btn-disabled');
          deleteText.textContent = '‡∏•‡∏ö';
          deleteSpinner.classList.add('hidden');
        }
      };
    }

    async function deleteAssessment(backendId) {
      const assessment = allData.find(d => d.__backendId === backendId);
      if (!assessment) return;

      const confirmEl = document.createElement('div');
      confirmEl.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
      confirmEl.innerHTML = `
        <div class="surface rounded-xl shadow-2xl p-8 max-w-md mx-4">
          <h3 class="text-2xl font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
          <p class="mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(assessment.assessmentDate)} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
          <div class="flex gap-4 justify-end">
            <button id="cancel-delete" class="btn-secondary px-6 py-3 rounded-lg font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button id="confirm-delete" class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 flex items-center gap-2">
              <span id="delete-text">‡∏•‡∏ö</span>
              <span id="delete-spinner" class="loading-spinner hidden"></span>
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmEl);

      document.getElementById('cancel-delete').onclick = () => {
        document.body.removeChild(confirmEl);
      };

      document.getElementById('confirm-delete').onclick = async () => {
        const deleteBtn = document.getElementById('confirm-delete');
        const deleteText = document.getElementById('delete-text');
        const deleteSpinner = document.getElementById('delete-spinner');
        
        deleteBtn.disabled = true;
        deleteBtn.classList.add('btn-disabled');
        deleteText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
        deleteSpinner.classList.remove('hidden');

        const result = await window.dataSdk.delete(assessment);
        
        if (result.isOk) {
          showToast('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          document.body.removeChild(confirmEl);
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
          deleteBtn.disabled = false;
          deleteBtn.classList.remove('btn-disabled');
          deleteText.textContent = '‡∏•‡∏ö';
          deleteSpinner.classList.add('hidden');
        }
      };
    }

    function formatThaiDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const thaiMonths = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
      return `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 surface px-6 py-4 rounded-lg shadow-xl z-50';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    window.onload = initApp;
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ Intermediate Care</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script><!-- Thailand.js dependencies -->
  <script src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dependencies/JQL.min.js"></script>
  <script src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dependencies/typeahead.bundle.js"></script>
  <script src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dist/jquery.Thailand.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .section-divider {
      border-top: 2px solid #e2e8f0;
      margin: 2rem 0;
    }

    /* Typeahead autocomplete styles */
    .twitter-typeahead {
      width: 100%;
    }
    
    .tt-menu {
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background-color: white;
      border: 2px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 0.5rem 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .tt-suggestion {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .tt-suggestion:hover,
    .tt-suggestion.tt-cursor {
      background-color: #3b82f6;
      color: white;
    }
    
    .tt-suggestion:last-child {
      border-bottom: none;
    }
  </style>
  <div id="app" class="w-full min-h-full"></div>
  <script>
    const defaultConfig = {
      background_color: "#f0f4f8",
      surface_color: "#ffffff",
      text_color: "#1e293b",
      primary_action: "#3b82f6",
      secondary_action: "#64748b",
      font_family: "Sarabun",
      font_size: 16,
      app_title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ Intermediate Care",
      patient_list_title: "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢",
      add_patient_button: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà"
    };

    let allData = [];
    let currentView = 'list';
    let selectedPatientId = null;
    let editingRecord = null;

    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        render();
      }
    };

    async function initApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Failed to initialize data SDK");
        return;
      }

      await window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });

      render();
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.surface_color || defaultConfig.surface_color,
            set: (value) => {
              config.surface_color = value;
              window.elementSdk.setConfig({ surface_color: value });
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              window.elementSdk.setConfig({ text_color: value });
            }
          },
          {
            get: () => config.primary_action || defaultConfig.primary_action,
            set: (value) => {
              config.primary_action = value;
              window.elementSdk.setConfig({ primary_action: value });
            }
          },
          {
            get: () => config.secondary_action || defaultConfig.secondary_action,
            set: (value) => {
              config.secondary_action = value;
              window.elementSdk.setConfig({ secondary_action: value });
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            config.font_family = value;
            window.elementSdk.setConfig({ font_family: value });
          }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => {
            config.font_size = value;
            window.elementSdk.setConfig({ font_size: value });
          }
        }
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["app_title", config.app_title || defaultConfig.app_title],
        ["patient_list_title", config.patient_list_title || defaultConfig.patient_list_title],
        ["add_patient_button", config.add_patient_button || defaultConfig.add_patient_button]
      ]);
    }

    async function onConfigChange(config) {
      const app = document.getElementById('app');
      if (!app) return;

      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action || defaultConfig.primary_action;
      const secondaryColor = config.secondary_action || defaultConfig.secondary_action;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;

      app.style.backgroundColor = bgColor;
      app.style.color = textColor;
      app.style.fontFamily = `${fontFamily}, 'Segoe UI', sans-serif`;
      app.style.fontSize = `${fontSize}px`;

      const headers = app.querySelectorAll('h1, h2, h3, h4');
      headers.forEach(h => {
        h.style.color = textColor;
        h.style.fontFamily = `${fontFamily}, 'Segoe UI', sans-serif`;
        if (h.tagName === 'H1') h.style.fontSize = `${fontSize * 2}px`;
        if (h.tagName === 'H2') h.style.fontSize = `${fontSize * 1.5}px`;
        if (h.tagName === 'H3') h.style.fontSize = `${fontSize * 1.25}px`;
        if (h.tagName === 'H4') h.style.fontSize = `${fontSize * 1.1}px`;
      });

      const cards = app.querySelectorAll('.card, .surface');
      cards.forEach(card => {
        card.style.backgroundColor = surfaceColor;
        card.style.color = textColor;
      });

      const primaryButtons = app.querySelectorAll('.btn-primary');
      primaryButtons.forEach(btn => {
        btn.style.backgroundColor = primaryColor;
        btn.style.color = '#ffffff';
      });

      const secondaryButtons = app.querySelectorAll('.btn-secondary');
      secondaryButtons.forEach(btn => {
        btn.style.backgroundColor = secondaryColor;
        btn.style.color = '#ffffff';
      });

      const labels = app.querySelectorAll('label, .text-sm');
      labels.forEach(label => {
        label.style.color = textColor;
        label.style.fontSize = `${fontSize * 0.875}px`;
      });

      const appTitleEl = app.querySelector('#app-title');
      if (appTitleEl) {
        appTitleEl.textContent = config.app_title || defaultConfig.app_title;
      }

      const patientListTitleEl = app.querySelector('#patient-list-title');
      if (patientListTitleEl) {
        patientListTitleEl.textContent = config.patient_list_title || defaultConfig.patient_list_title;
      }

      const addPatientBtnEl = app.querySelector('#add-patient-btn');
      if (addPatientBtnEl) {
        addPatientBtnEl.textContent = config.add_patient_button || defaultConfig.add_patient_button;
      }
    }

    function initThailandAutocomplete() {
      setTimeout(() => {
        if (typeof $.Thailand !== 'undefined') {
          $.Thailand({
            database: 'https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/database/db.json',
            $district: $('#subdistrict'),
            $amphoe: $('#district'), 
            $province: $('#province'),
            $zipcode: $('#zipcode'),
            onDataFill: function(data) {
              console.log('Address data filled:', data);
            }
          });
        }
      }, 100);
    }

    function setAddressFields(patient) {
      if (!patient) return;

      setTimeout(() => {
        const subdistrictInput = document.getElementById('district');
        const districtInput = document.getElementById('amphoe');
        const provinceInput = document.getElementById('province');
        const zipcodeInput = document.getElementById('zipcode');
        const houseNumberInput = document.getElementById('houseNumber');
        const mooInput = document.getElementById('moo');

        if (houseNumberInput && patient.houseNumber) {
          houseNumberInput.value = patient.houseNumber;
        }
        if (mooInput && patient.moo) {
          mooInput.value = patient.moo;
        }
        if (subdistrictInput && patient.subdistrict) {
          subdistrictInput.value = patient.subdistrict;
        }
        if (districtInput && patient.district) {
          districtInput.value = patient.district;
        }
        if (provinceInput && patient.province) {
          provinceInput.value = patient.province;
        }
        if (zipcodeInput && patient.zipcode) {
          zipcodeInput.value = patient.zipcode;
        }

        // Trigger Thailand.js ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâÔøΩÔøΩ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤
        initThailandAutocomplete();
      }, 200);
    }

    function render() {
      const app = document.getElementById('app');
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;

      if (currentView === 'list') {
        app.innerHTML = renderPatientList();
      } else if (currentView === 'patient-detail') {
        app.innerHTML = renderPatientDetail();
      } else if (currentView === 'add-patient') {
        app.innerHTML = renderPatientForm('add');
        initThailandAutocomplete();
      } else if (currentView === 'edit-patient') {
        app.innerHTML = renderPatientForm('edit');
        const patient = allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId);
        setAddressFields(patient);
      } else if (currentView === 'add-assessment') {
        app.innerHTML = renderAssessmentForm('add');
      } else if (currentView === 'edit-assessment') {
        app.innerHTML = renderAssessmentForm('edit');
      }

      onConfigChange(config);
    }

    function getFullAddress(patient) {
      const parts = [];
      if (patient.houseNumber) parts.push(patient.houseNumber);
      if (patient.moo) parts.push(`‡∏´‡∏°‡∏π‡πà ${patient.moo}`);
      if (patient.subdistrict) parts.push(`‡∏ï.${patient.subdistrict}`);
      if (patient.district) parts.push(`‡∏≠.${patient.district}`);
      if (patient.province) parts.push(`‡∏à.${patient.province}`);
      if (patient.zipcode) parts.push(patient.zipcode);
      return parts.length > 0 ? parts.join(' ') : '-';
    }

    function renderPatientList() {
      const patients = allData.filter(d => d.type === 'patient');
      
      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-8">
              <h1 id="app-title" class="text-4xl font-bold">${defaultConfig.app_title}</h1>
              <button id="add-patient-btn" onclick="showAddPatient()" class="btn-primary px-6 py-3 rounded-lg font-semibold transition-all">
                ${defaultConfig.add_patient_button}
              </button>
            </div>

            <div class="surface rounded-xl shadow-lg p-6">
              <h2 id="patient-list-title" class="text-2xl font-semibold mb-6">${defaultConfig.patient_list_title}</h2>
              
              ${patients.length === 0 ? `
                <div class="text-center py-12">
                  <p class="text-xl opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
                  <p class="mt-2 opacity-50">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</p>
                </div>
              ` : `
                <div class="space-y-4">
                  ${patients.map(patient => `
                    <div class="card card-hover p-5 rounded-lg border-2 border-gray-200 cursor-pointer transition-all" onclick="showPatientDetail('${patient.patientId}')">
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <h3 class="text-xl font-semibold mb-3">${patient.firstName} ${patient.lastName}</h3>
                          <div class="grid grid-cols-3 gap-x-6 gap-y-2 text-sm opacity-75">
                            <p><strong>HN:</strong> ${patient.hn}</p>
                            <p><strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${patient.age} ‡∏õ‡∏µ</p>
                            <p><strong>‡πÄ‡∏û‡∏®:</strong> ${patient.gender}</p>
                            <p><strong>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</strong> ${patient.medicalRights || '-'}</p>
                            <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${patient.phoneNumber || '-'}</p>
                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤ IMC:</strong> ${formatThaiDate(patient.imcAdmitDate)}</p>
                          </div>
                          <p class="mt-3 text-sm"><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${getFullAddress(patient)}</p>
                          ${patient.diagnosisDetails ? `<p class="mt-2 text-sm"><strong>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢:</strong> ${patient.diagnosisDetails}</p>` : ''}
                        </div>
                        <div class="flex gap-2 ml-4">
                          <button onclick="event.stopPropagation(); showEditPatient('${patient.patientId}')" class="btn-secondary px-4 py-2 rounded text-sm font-semibold">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                          </button>
                          <button onclick="event.stopPropagation(); deletePatient('${patient.patientId}')" class="bg-red-500 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-red-600">
                            ‡∏•‡∏ö
                          </button>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderPatientDetail() {
      const patient = allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId);
      if (!patient) {
        currentView = 'list';
        render();
        return '';
      }

      const assessments = allData.filter(d => d.type === 'assessment' && d.patientId === selectedPatientId)
        .sort((a, b) => new Date(b.assessmentDate) - new Date(a.assessmentDate));

      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-7xl mx-auto">
            <button onclick="backToList()" class="btn-secondary px-4 py-2 rounded-lg mb-6 font-semibold">
              ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
            </button>

            <div class="surface rounded-xl shadow-lg p-6 mb-6">
              <div class="flex justify-between items-start mb-6">
                <h2 class="text-3xl font-bold">${patient.firstName} ${patient.lastName}</h2>
                <button onclick="showEditPatient('${patient.patientId}')" class="btn-secondary px-5 py-2 rounded-lg font-semibold">
                  ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
              </div>

              <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
              <h4 class="text-lg font-semibold mb-3 text-blue-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h4>
              <div class="grid grid-cols-3 gap-x-8 gap-y-3 mb-4">
                <p><strong>HN:</strong> ${patient.hn}</p>
                <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> ${patient.nationalId || '-'}</p>
                <p><strong>‡πÄ‡∏û‡∏®:</strong> ${patient.gender}</p>
                <p><strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${patient.age} ‡∏õ‡∏µ</p>
                <p><strong>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</strong> ${patient.medicalRights || '-'}</p>
                <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> ${patient.phoneNumber || '-'}</p>
                <p class="col-span-3"><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${getFullAddress(patient)}</p>
              </div>
              
              ${patient.gpsCoordinates ? `
                <div class="mb-4">
                  <p class="font-semibold mb-2">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${patient.gpsCoordinates}</p>
                  <div class="rounded-lg overflow-hidden">
                    <iframe src="https://maps.google.com/maps?q=${patient.gpsCoordinates}&z=15&output=embed" 
                      width="100%" height="300" frameborder="0" style="border:0" allowfullscreen></iframe>
                  </div>
                </div>
              ` : ''}

              <div class="section-divider"></div>

              <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢ -->
              <h4 class="text-lg font-semibold mb-3 text-blue-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢</h4>
              <div class="grid grid-cols-2 gap-x-8 gap-y-3 mb-4">
                <p><strong>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</strong> ${patient.underlyingDiseases || '-'}</p>
                <p><strong>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ:</strong> ${patient.diagnosisDetails || '-'}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô:</strong> ${formatThaiDate(patient.onsetDate) || '-'}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Admit:</strong> ${formatThaiDate(patient.admitDate) || '-'}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ÇÔøΩÔøΩ‡∏≤ IMC:</strong> ${formatThaiDate(patient.imcAdmitDate)}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢:</strong> ${formatThaiDate(patient.dischargeDate) || '-'}</p>
              </div>
              
              ${patient.labResults ? `
                <div class="mb-3">
                  <p class="font-semibold mb-1">‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£:</p>
                  <p class="text-sm bg-gray-50 p-3 rounded">${patient.labResults}</p>
                </div>
              ` : ''}

              ${patient.additionalNotes ? `
                <div>
                  <p class="font-semibold mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</p>
                  <p class="text-sm bg-gray-50 p-3 rounded">${patient.additionalNotes}</p>
                </div>
              ` : ''}
            </div>

            <div class="surface rounded-xl shadow-lg p-6">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•</h3>
                <button onclick="showAddAssessment()" class="btn-primary px-6 py-3 rounded-lg font-semibold">
                  + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                </button>
              </div>

              ${assessments.length === 0 ? `
                <div class="text-center py-12">
                  <p class="text-xl opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•</p>
                  <p class="mt-2 opacity-50">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
                </div>
              ` : `
                <div class="space-y-4">
                  ${assessments.map(assessment => `
                    <div class="card p-5 rounded-lg border-2 border-gray-200">
                      <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                          <p class="text-lg font-semibold mb-3">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: ${formatThaiDate(assessment.assessmentDate)}</p>
                          <div class="grid grid-cols-1 gap-4">
                            <div class="bg-blue-50 p-3 rounded">
                              <p class="font-semibold text-sm opacity-75 mb-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô BI (Barthel Index):</p>
                              <p class="text-2xl font-bold text-blue-600">${assessment.biScore} / 100</p>
                              ${assessment.biDetails ? `<p class="text-sm mt-2">${assessment.biDetails}</p>` : ''}
                            </div>
                            <div>
                              <p class="font-semibold text-sm opacity-75 mb-1">PT Assessment:</p>
                              <p class="text-sm whitespace-pre-line">${assessment.ptAssessment || '-'}</p>
                            </div>
                            <div>
                              <p class="font-semibold text-sm opacity-75 mb-1">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</p>
                              <p class="text-sm whitespace-pre-line">${assessment.ptGoals || '-'}</p>
                            </div>
                            ${assessment.notes ? `
                              <div>
                                <p class="font-semibold text-sm opacity-75 mb-1">‡∏´‡∏°‡∏≤‡∏¢ÔøΩÔøΩÔøΩ‡∏´‡∏ï‡∏∏:</p>
                                <p class="text-sm whitespace-pre-line bg-yellow-50 p-2 rounded">${assessment.notes}</p>
                              </div>
                            ` : ''}
                          </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                          <button onclick="showEditAssessment('${assessment.__backendId}')" class="btn-secondary px-4 py-2 rounded text-sm font-semibold">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                          </button>
                          <button onclick="deleteAssessment('${assessment.__backendId}')" class="bg-red-500 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-red-600">
                            ‡∏•‡∏ö
                          </button>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderPatientForm(mode) {
      const isEdit = mode === 'edit';
      const patient = isEdit ? allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId) : null;

      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-5xl mx-auto">
            <button onclick="${isEdit ? `showPatientDetail('${selectedPatientId}')` : 'backToList()'}" class="btn-secondary px-4 py-2 rounded-lg mb-6 font-semibold">
              ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            </button>

            <div class="surface rounded-xl shadow-lg p-8">
              <h2 class="text-3xl font-bold mb-8">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà'}</h2>

              <form id="patient-form" onsubmit="savePatient(event, '${mode}')">
                
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
                <h3 class="text-xl font-semibold mb-4 text-blue-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                <div class="space-y-4 mb-6">
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label for="firstName" class="block font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠ *</label>
                      <input type="text" id="firstName" name="firstName" value="${isEdit ? patient.firstName : ''}" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="lastName" class="block font-semibold mb-2">‡∏™‡∏Å‡∏∏‡∏• *</label>
                      <input type="text" id="lastName" name="lastName" value="${isEdit ? patient.lastName : ''}" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div class="grid grid-cols-3 gap-4">
                    <div>
                      <label for="hn" class="block font-semibold mb-2">HN *</label>
                      <input type="text" id="hn" name="hn" value="${isEdit ? patient.hn : ''}" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="nationalId" class="block font-semibold mb-2">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                      <input type="text" id="nationalId" name="nationalId" value="${isEdit ? patient.nationalId || '' : ''}" maxlength="13"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="gender" class="block font-semibold mb-2">‡πÄ‡∏û‡∏® *</label>
                      <select id="gender" name="gender" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®</option>
                        <option value="‡∏ä‡∏≤‡∏¢" ${isEdit && patient.gender === '‡∏ä‡∏≤‡∏¢' ? 'selected' : ''}>‡∏ä‡∏≤‡∏¢</option>
                        <option value="‡∏´‡∏ç‡∏¥‡∏á" ${isEdit && patient.gender === '‡∏´‡∏ç‡∏¥‡∏á' ? 'selected' : ''}>‡∏´‡∏ç‡∏¥‡∏á</option>
                      </select>
                    </div>
                  </div>

                  <div class="grid grid-cols-3 gap-4">
                    <div>
                      <label for="age" class="block font-semibold mb-2">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ) *</label>
                      <input type="number" id="age" name="age" value="${isEdit ? patient.age : ''}" required min="0" max="150"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="phoneNumber" class="block font-semibold mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                      <input type="tel" id="phoneNumber" name="phoneNumber" value="${isEdit ? patient.phoneNumber || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="medicalRights" class="block font-semibold mb-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                      <input type="text" id="medicalRights" name="medicalRights" value="${isEdit ? patient.medicalRights || '' : ''}"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div>
                    <label class="block font-semibold mb-3">‡∏ó‡∏µ‡πà‡∏≠‡∏¢ÔøΩÔøΩ‡πà</label>
                    <div class="space-y-3">
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <label for="houseNumber" class="block text-sm font-semibold mb-1">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏ã‡∏≠‡∏¢ / ‡∏ñ‡∏ô‡∏ô</label>
                          <input type="text" id="houseNumber" name="houseNumber" 
                            value="${isEdit ? patient.houseNumber || '' : ''}"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô 123 ‡∏ã‡∏≠‡∏¢‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó 21"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                          <label for="moo" class="block text-sm font-semibold mb-1">‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</label>
                          <input type="text" id="moo" name="moo" 
                            value="${isEdit ? patient.moo || '' : ''}"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô 5"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                      </div>
                      <div class="grid grid-cols-4 gap-4">
                        <div>
                          <label for="district" class="block text-sm font-semibold mb-1">‡∏ï‡∏≥‡∏ö‡∏•</label>
                          <input type="text" id="district" name="district"
                            value="${isEdit ? patient.subdistrict || '' : ''}"
                            placeholder="‡∏ï‡∏≥‡∏ö‡∏•"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                          <label for="amphoe" class="block text-sm font-semibold mb-1">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
                          <input type="text" id="amphoe" name="amphoe"
                            value="${isEdit ? patient.district || '' : ''}"
                            placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                          <label for="province" class="block text-sm font-semibold mb-1">ÔøΩÔøΩ‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                          <input type="text" id="province" name="province"
                            value="${isEdit ? patient.province || '' : ''}"
                            placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                          <label for="zipcode" class="block text-sm font-semibold mb-1">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                          <input type="text" id="zipcode" name="zipcode"
                            value="${isEdit ? patient.zipcode || '' : ''}"
                            placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå"
                            maxlength="5"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                      </div>
                    </div>
                  </div>

                  <div>
                    <label for="gpsCoordinates" class="block font-semibold mb-2">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                    <input type="text" id="gpsCoordinates" name="gpsCoordinates" value="${isEdit ? patient.gpsCoordinates || '' : ''}"
                      placeholder="‡πÄ‡∏ä‡πà‡∏ô 13.7563, 100.5018"
                      oninput="updateMap()"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    <div id="map-preview" class="mt-2 rounded-lg overflow-hidden" style="display: none;">
                      <iframe id="map-iframe" width="100%" height="300" frameborder="0" style="border:0" allowfullscreen></iframe>
                    </div>
                  </div>
                </div>

                <div class="section-divider"></div>

                <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢ -->
                <h3 class="text-xl font-semibold mb-4 text-blue-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢</h3>
                <div class="space-y-4 mb-6">
                  <div>
                    <label class="block font-semibold mb-3">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                    <div class="grid grid-cols-3 gap-4">
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="HT" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('HT') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>HT (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="DM" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('DM') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>DM (‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="DLP" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('DLP') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>DLP (‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="CKD" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('CKD') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>CKD (‡πÑ‡∏ï‡∏ß‡∏≤‡∏¢)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="Heart disease" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('Heart disease') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>Heart disease (‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à)</span>
                      </label>
                    </div>
                    <div class="mt-3">
                      <label for="otherDiseases" class="block text-sm font-semibold mb-1">‡∏≠ÔøΩÔøΩ‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</label>
                      <input type="text" id="otherDiseases" name="otherDiseases" 
                        value="${isEdit && patient.underlyingDiseases ? patient.underlyingDiseases.split(',').filter(d => !['HT', 'DM', 'DLP', 'CKD', 'Heart disease'].includes(d.trim())).join(', ') : ''}"
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏Ñ‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div>
                    <label class="block font-semibold mb-3">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ</label>
                    <div class="space-y-4">
                      <!-- Stroke -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer mb-3">
                          <input type="checkbox" id="diagnosis-stroke" name="diagnosis" value="Stroke" 
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Stroke') ? 'checked' : ''}
                            onchange="toggleStrokeDetails(this.checked)"
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">Stroke</span>
                        </label>
                        <div id="stroke-details" class="ml-7 space-y-2" style="display: ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Stroke') ? 'block' : 'none'}">
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="stroke_type" value="Ischemic stroke"
                              ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Ischemic stroke') ? 'checked' : ''}
                              class="w-4 h-4">
                            <span class="text-sm">Ischemic stroke</span>
                          </label>
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="stroke_type" value="Hemorrhagic stroke"
                              ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Hemorrhagic stroke') ? 'checked' : ''}
                              class="w-4 h-4">
                            <span class="text-sm">Hemorrhagic stroke</span>
                          </label>
                        </div>
                      </div>

                      <!-- TBI -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" name="diagnosis" value="TBI"
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('TBI') ? 'checked' : ''}
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">TBI (Traumatic Brain Injury)</span>
                        </label>
                      </div>

                      <!-- SCI -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" name="diagnosis" value="SCI"
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('SCI') ? 'checked' : ''}
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">SCI (Spinal Cord Injury)</span>
                        </label>
                      </div>

                      <!-- Hip fracture -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer mb-3">
                          <input type="checkbox" id="diagnosis-hip" name="diagnosis" value="Hip fracture"
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Hip fracture') ? 'checked' : ''}
                            onchange="toggleHipDetails(this.checked)"
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">Hip fracture</span>
                        </label>
                        <div id="hip-details" class="ml-7 space-y-3" style="display: ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Hip fracture') ? 'block' : 'none'}">
                          <div>
                            <p class="text-sm font-semibold mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</p>
                            <div class="space-y-2">
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_location" value="Neck of femur"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Neck of femur') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Neck of femur</span>
                              </label>
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_location" value="Intertrochanter"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Intertrochanter') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Intertrochanter</span>
                              </label>
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_location" value="Subtrochanter"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Subtrochanter') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Subtrochanter</span>
                              </label>
                            </div>
                          </div>
                          <div>
                            <p class="text-sm font-semibold mb-2">‡∏Ç‡πâ‡∏≤‡∏á:</p>
                            <div class="flex gap-4">
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_side" value="Lt"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Lt') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Lt. (‡∏ã‡πâ‡∏≤‡∏¢)</span>
                              </label>
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_side" value="Rt"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Rt') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Rt. (‡∏Ç‡∏ß‡∏≤)</span>
                              </label>
                            </div>
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label for="onsetDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô</label>
                      <input type="date" id="onsetDate" name="onsetDate" value="${isEdit ? patient.onsetDate || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="admitDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Admit</label>
                      <input type="date" id="admitDate" name="admitDate" value="${isEdit ? patient.admitDate || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label for="imcAdmitDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤ IMC *</label>
                      <input type="date" id="imcAdmitDate" name="imcAdmitDate" value="${isEdit ? patient.imcAdmitDate : ''}" required
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="dischargeDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô</label>
                      <input type="date" id="dischargeDate" name="dischargeDate" value="${isEdit ? patient.dischargeDate || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div>
                    <label for="labResults" class="block font-semibold mb-2">‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ÔøΩÔøΩ‡∏≤‡∏£</label>
                    <textarea id="labResults" name="labResults" rows="3" 
                      placeholder="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏áÔøΩÔøΩÔøΩ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? patient.labResults || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="additionalNotes" class="block font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="additionalNotes" name="additionalNotes" rows="3" 
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? patient.additionalNotes || '' : ''}</textarea>
                  </div>
                </div>

                <div class="flex justify-end gap-4 mt-8">
                  <button type="button" onclick="${isEdit ? `showPatientDetail('${selectedPatientId}')` : 'backToList()'}" 
                    class="btn-secondary px-6 py-3 rounded-lg font-semibold">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                  </button>
                  <button type="submit" id="submit-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                    <span id="submit-text">${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'}</span>
                    <span id="submit-spinner" class="loading-spinner hidden"></span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    function renderAssessmentForm(mode) {
      const isEdit = mode === 'edit';
      const assessment = isEdit ? allData.find(d => d.__backendId === editingRecord) : null;

      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-4xl mx-auto">
            <button onclick="showPatientDetail('${selectedPatientId}')" class="btn-secondary px-4 py-2 rounded-lg mb-6 font-semibold">
              ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            </button>

            <div class="surface rounded-xl shadow-lg p-8">
              <h2 class="text-3xl font-bold mb-6">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ôÔøΩÔøΩ‡∏´‡∏°‡πà'}</h2>

              <form id="assessment-form" onsubmit="saveAssessment(event, '${mode}')">
                <div class="space-y-4">
                  <div>
                    <label for="assessmentDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô *</label>
                    <input type="date" id="assessmentDate" name="assessmentDate" 
                      value="${isEdit ? assessment.assessmentDate : ''}" required 
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                  </div>

                  <div>
                    <label for="biScore" class="block font-semibold mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô BI (Barthel Index) * (0-100)</label>
                    <input type="number" id="biScore" name="biScore" min="0" max="100" 
                      value="${isEdit ? assessment.biScore : ''}" required 
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                  </div>

                  <div>
                    <label for="biDetails" class="block font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î BI</label>
                    <textarea id="biDetails" name="biDetails" rows="3" 
                      placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.biDetails || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="ptAssessment" class="block font-semibold mb-2">PT Assessment</label>
                    <textarea id="ptAssessment" name="ptAssessment" rows="4" 
                      placeholder="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.ptAssessment || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="ptGoals" class="block font-semibold mb-2">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                    <textarea id="ptGoals" name="ptGoals" rows="3" 
                      placeholder="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.ptGoals || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="notes" class="block font-semibold mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="notes" name="notes" rows="3" 
                      placeholder="‡∏´ÔøΩÔøΩÔøΩ‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.notes || '' : ''}</textarea>
                  </div>

                  <div class="flex justify-end gap-4 mt-8">
                    <button type="button" onclick="showPatientDetail('${selectedPatientId}')" 
                      class="btn-secondary px-6 py-3 rounded-lg font-semibold">
                      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" id="submit-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                      <span id="submit-text">${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'}</span>
                      <span id="submit-spinner" class="loading-spinner hidden"></span>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    function toggleStrokeDetails(checked) {
      const strokeDetails = document.getElementById('stroke-details');
      if (strokeDetails) {
        strokeDetails.style.display = checked ? 'block' : 'none';
      }
    }

    function toggleHipDetails(checked) {
      const hipDetails = document.getElementById('hip-details');
      if (hipDetails) {
        hipDetails.style.display = checked ? 'block' : 'none';
      }
    }

    function updateMap() {
      const gpsInput = document.getElementById('gpsCoordinates');
      const mapPreview = document.getElementById('map-preview');
      const mapIframe = document.getElementById('map-iframe');
      
      if (!gpsInput || !mapPreview || !mapIframe) return;
      
      const coords = gpsInput.value.trim();
      if (coords && coords.includes(',')) {
        const [lat, lng] = coords.split(',').map(c => c.trim());
        if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
          mapIframe.src = `https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed`;
          mapPreview.style.display = 'block';
        } else {
          mapPreview.style.display = 'none';
        }
      } else {
        mapPreview.style.display = 'none';
      }
    }
    
    setTimeout(() => {
      updateMap();
    }, 100);

    function showAddPatient() {
      if (allData.filter(d => d.type === 'patient').length >= 999) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢');
        return;
      }
      currentView = 'add-patient';
      render();
    }

    function showEditPatient(patientId) {
      selectedPatientId = patientId;
      currentView = 'edit-patient';
      render();
    }

    function showPatientDetail(patientId) {
      selectedPatientId = patientId;
      currentView = 'patient-detail';
      render();
    }

    function showAddAssessment() {
      if (allData.length >= 999) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°ÔøΩÔøΩ‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢‡∏ÅÔøΩÔøΩ‡∏£');
        return;
      }
      currentView = 'add-assessment';
      render();
    }

    function showEditAssessment(backendId) {
      editingRecord = backendId;
      currentView = 'edit-assessment';
      render();
    }

    function backToList() {
      selectedPatientId = null;
      currentView = 'list';
      render();
    }

    async function savePatient(event, mode) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');
      
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-disabled');
      submitText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      submitSpinner.classList.remove('hidden');

      const formData = new FormData(event.target);
      
      // ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß
      const diseases = [];
      const diseaseCheckboxes = event.target.querySelectorAll('input[name="disease"]:checked');
      diseaseCheckboxes.forEach(cb => diseases.push(cb.value));
      const otherDiseases = formData.get('otherDiseases');
      if (otherDiseases && otherDiseases.trim()) {
        diseases.push(otherDiseases.trim());
      }
      
      // ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ
      const diagnosisParts = [];
      const diagnosisCheckboxes = event.target.querySelectorAll('input[name="diagnosis"]:checked');
      diagnosisCheckboxes.forEach(cb => {
        const value = cb.value;
        diagnosisParts.push(value);
        
        if (value === 'Stroke') {
          const strokeType = event.target.querySelector('input[name="stroke_type"]:checked');
          if (strokeType) {
            diagnosisParts.push(strokeType.value);
          }
        }
        
        if (value === 'Hip fracture') {
          const hipLocation = event.target.querySelector('input[name="hip_location"]:checked');
          if (hipLocation) {
            diagnosisParts.push(hipLocation.value);
          }
          const hipSide = event.target.querySelector('input[name="hip_side"]:checked');
          if (hipSide) {
            diagnosisParts.push(hipSide.value);
          }
        }
      });
      
      const patientData = {
        type: 'patient',
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        hn: formData.get('hn'),
        nationalId: formData.get('nationalId') || null,
        birthDate: null,
        age: parseInt(formData.get('age')),
        gender: formData.get('gender'),
        medicalRights: formData.get('medicalRights') || null,
        houseNumber: formData.get('houseNumber') || null,
        moo: formData.get('moo') || null,
        subdistrict: formData.get('district') || null,
        district: formData.get('amphoe') || null,
        province: formData.get('province') || null,
        zipcode: formData.get('zipcode') || null,
        gpsCoordinates: formData.get('gpsCoordinates') || null,
        phoneNumber: formData.get('phoneNumber') || null,
        underlyingDiseases: diseases.length > 0 ? diseases.join(', ') : null,
        diagnosisDetails: diagnosisParts.length > 0 ? diagnosisParts.join(' | ') : null,
        onsetDate: formData.get('onsetDate') || null,
        admitDate: formData.get('admitDate') || null,
        imcAdmitDate: formData.get('imcAdmitDate'),
        dischargeDate: formData.get('dischargeDate') || null,
        labResults: formData.get('labResults') || null,
        additionalNotes: formData.get('additionalNotes') || null,
        createdAt: new Date().toISOString()
      };

      let result;
      if (mode === 'add') {
        if (allData.filter(d => d.type === 'patient').length >= 999) {
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢');
          submitBtn.disabled = false;
          submitBtn.classList.remove('btn-disabled');
          submitText.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢';
          submitSpinner.classList.add('hidden');
          return;
        }
        patientData.patientId = 'P' + Date.now();
        result = await window.dataSdk.create(patientData);
      } else {
        const existing = allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId);
        result = await window.dataSdk.update({ ...existing, ...patientData });
      }

      submitBtn.disabled = false;
      submitBtn.classList.remove('btn-disabled');
      submitSpinner.classList.add('hidden');

      if (result.isOk) {
        showToast(mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        if (mode === 'add') {
          backToList();
        } else {
          showPatientDetail(selectedPatientId);
        }
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠ÔøΩÔøΩ‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
        submitText.textContent = mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢' : 'ÔøΩÔøΩÔøΩ‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
      }
    }

    async function saveAssessment(event, mode) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');
      
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-disabled');
      submitText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      submitSpinner.classList.remove('hidden');

      const formData = new FormData(event.target);
      const assessmentData = {
        type: 'assessment',
        patientId: selectedPatientId,
        assessmentDate: formData.get('assessmentDate'),
        biScore: parseInt(formData.get('biScore')),
        biDetails: formData.get('biDetails') || null,
        ptAssessment: formData.get('ptAssessment') || null,
        ptGoals: formData.get('ptGoals') || null,
        notes: formData.get('notes') || null,
        createdAt: new Date().toISOString()
      };

      let result;
      if (mode === 'add') {
        if (allData.length >= 999) {
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
          submitBtn.disabled = false;
          submitBtn.classList.remove('btn-disabled');
          submitText.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô';
          submitSpinner.classList.add('hidden');
          return;
        }
        result = await window.dataSdk.create(assessmentData);
      } else {
        const existing = allData.find(d => d.__backendId === editingRecord);
        result = await window.dataSdk.update({ ...existing, ...assessmentData });
      }

      submitBtn.disabled = false;
      submitBtn.classList.remove('btn-disabled');
      submitSpinner.classList.add('hidden');

      if (result.isOk) {
        showToast(mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        showPatientDetail(selectedPatientId);
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
        submitText.textContent = mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
      }
    }

    async function deletePatient(patientId) {
      const patient = allData.find(d => d.type === 'patient' && d.patientId === patientId);
      if (!patient) return;

      const assessments = allData.filter(d => d.type === 'assessment' && d.patientId === patientId);
      
      const confirmEl = document.createElement('div');
      confirmEl.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
      confirmEl.innerHTML = `
        <div class="surface rounded-xl shadow-2xl p-8 max-w-md mx-4">
          <h3 class="text-2xl font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
          <p class="mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ "${patient.firstName} ${patient.lastName}" ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${assessments.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
          <div class="flex gap-4 justify-end">
            <button id="cancel-delete" class="btn-secondary px-6 py-3 rounded-lg font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button id="confirm-delete" class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 flex items-center gap-2">
              <span id="delete-text">‡∏•‡∏ö</span>
              <span id="delete-spinner" class="loading-spinner hidden"></span>
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmEl);

      document.getElementById('cancel-delete').onclick = () => {
        document.body.removeChild(confirmEl);
      };

      document.getElementById('confirm-delete').onclick = async () => {
        const deleteBtn = document.getElementById('confirm-delete');
        const deleteText = document.getElementById('delete-text');
        const deleteSpinner = document.getElementById('delete-spinner');
        
        deleteBtn.disabled = true;
        deleteBtn.classList.add('btn-disabled');
        deleteText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
        deleteSpinner.classList.remove('hidden');

        for (const assessment of assessments) {
          await window.dataSdk.delete(assessment);
        }
        
        const result = await window.dataSdk.delete(patient);
        
        if (result.isOk) {
          showToast('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          document.body.removeChild(confirmEl);
        } else {
          showToast('‡πÄ‡∏ÅÔøΩÔøΩÔøΩ‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
          deleteBtn.disabled = false;
          deleteBtn.classList.remove('btn-disabled');
          deleteText.textContent = '‡∏•‡∏ö';
          deleteSpinner.classList.add('hidden');
        }
      };
    }

    async function deleteAssessment(backendId) {
      const assessment = allData.find(d => d.__backendId === backendId);
      if (!assessment) return;

      const confirmEl = document.createElement('div');
      confirmEl.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
      confirmEl.innerHTML = `
        <div class="surface rounded-xl shadow-2xl p-8 max-w-md mx-4">
          <h3 class="text-2xl font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
          <p class="mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(assessment.assessmentDate)} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
          <div class="flex gap-4 justify-end">
            <button id="cancel-delete" class="btn-secondary px-6 py-3 rounded-lg font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button id="confirm-delete" class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 flex items-center gap-2">
              <span id="delete-text">‡∏•‡∏ö</span>
              <span id="delete-spinner" class="loading-spinner hidden"></span>
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmEl);

      document.getElementById('cancel-delete').onclick = () => {
        document.body.removeChild(confirmEl);
      };

      document.getElementById('confirm-delete').onclick = async () => {
        const deleteBtn = document.getElementById('confirm-delete');
        const deleteText = document.getElementById('delete-text');
        const deleteSpinner = document.getElementById('delete-spinner');
        
        deleteBtn.disabled = true;
        deleteBtn.classList.add('btn-disabled');
        deleteText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
        deleteSpinner.classList.remove('hidden');

        const result = await window.dataSdk.delete(assessment);
        
        if (result.isOk) {
          showToast('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          document.body.removeChild(confirmEl);
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
          deleteBtn.disabled = false;
          deleteBtn.classList.remove('btn-disabled');
          deleteText.textContent = '‡∏•‡∏ö';
          deleteSpinner.classList.add('hidden');
        }
      };
    }

    function formatThaiDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const thaiMonths = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
      return `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 surface px-6 py-4 rounded-lg shadow-xl z-50';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    window.onload = initApp;
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ Intermediate Care</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script><!-- Thailand.js dependencies -->
  <script src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dependencies/JQL.min.js"></script>
  <script src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dependencies/typeahead.bundle.js"></script>
  <script src="https://earthchie.github.io/jquery.Thailand.js/jquery.Thailand.js/dist/jquery.Thailand.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .section-divider {
      border-top: 2px solid #e2e8f0;
      margin: 2rem 0;
    }
  </style>
  <div id="app" class="w-full min-h-full"></div>
  <script>
    const defaultConfig = {
      background_color: "#f0f4f8",
      surface_color: "#ffffff",
      text_color: "#1e293b",
      primary_action: "#3b82f6",
      secondary_action: "#64748b",
      font_family: "Sarabun",
      font_size: 16,
      app_title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ Intermediate Care",
      patient_list_title: "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢",
      add_patient_button: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà"
    };

    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
    let thailandData = {};
    let isLoadingAddressData = true;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏≤‡∏Å API
    async function loadThailandAddressData() {
      try {
        const response = await fetch('https://raw.githubusercontent.com/earthchie/jquery.Thailand.js/master/jquery.Thailand.js/database/db.json');
        const data = await response.json();
        
        // ‡∏à‡∏±‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô { ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: { ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: [‡∏ï‡∏≥‡∏ö‡∏•] } }
        thailandData = {};
        data.forEach(item => {
          const province = item.province;
          const district = item.amphoe;
          const subdistrict = item.district;
          
          if (!thailandData[province]) {
            thailandData[province] = {};
          }
          if (!thailandData[province][district]) {
            thailandData[province][district] = [];
          }
          if (!thailandData[province][district].includes(subdistrict)) {
            thailandData[province][district].push(subdistrict);
          }
        });
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
        Object.keys(thailandData).forEach(province => {
          Object.keys(thailandData[province]).forEach(district => {
            thailandData[province][district].sort((a, b) => a.localeCompare(b, 'th'));
          });
        });
        
        isLoadingAddressData = false;
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°
        if (currentView === 'add-patient' || currentView === 'edit-patient') {
          initProvinceDropdown();
        }
      } catch (error) {
        console.error('Failed to load Thailand address data:', error);
        isLoadingAddressData = false;
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á
        thailandData = {
          "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£": {
            "‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å": ["‡∏™‡∏µ‡πà‡∏û‡∏£‡∏∞‡∏¢‡∏≤", "‡∏°‡∏´‡∏≤‡∏û‡∏§‡∏í‡∏≤‡∏£‡∏≤‡∏°", "‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏ß‡∏á‡∏®‡πå"],
            "‡πÄ‡∏Ç‡∏ï‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢": ["‡∏ß‡∏±‡∏î‡πÄ‡∏ó‡∏û‡∏®‡∏¥‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö", "‡∏ß‡∏±‡∏î‡πÇ‡∏™‡∏°‡∏ô‡∏±‡∏™"]
          },
          "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà": {
            "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°ÔøΩÔøΩÔøΩ": ["‡∏®‡∏£‡∏µ‡∏†‡∏π‡∏°‡∏¥", "‡∏û‡∏£‡∏∞‡∏™‡∏¥‡∏á‡∏´‡πå", "‡∏´‡∏≤‡∏¢‡∏¢‡∏≤"],
            "‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢": ["‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢‡∏´‡∏•‡∏ß‡∏á", "‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢", "‡∏™‡∏±‡∏ô‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠"]
          }
        };
      }
    }

    let allData = [];
    let currentView = 'list';
    let selectedPatientId = null;
    let editingRecord = null;

    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        render();
      }
    };

    async function initApp() {
      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
      loadThailandAddressData();
      
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Failed to initialize data SDK");
        return;
      }

      await window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });

      render();
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.surface_color || defaultConfig.surface_color,
            set: (value) => {
              config.surface_color = value;
              window.elementSdk.setConfig({ surface_color: value });
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              window.elementSdk.setConfig({ text_color: value });
            }
          },
          {
            get: () => config.primary_action || defaultConfig.primary_action,
            set: (value) => {
              config.primary_action = value;
              window.elementSdk.setConfig({ primary_action: value });
            }
          },
          {
            get: () => config.secondary_action || defaultConfig.secondary_action,
            set: (value) => {
              config.secondary_action = value;
              window.elementSdk.setConfig({ secondary_action: value });
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            config.font_family = value;
            window.elementSdk.setConfig({ font_family: value });
          }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => {
            config.font_size = value;
            window.elementSdk.setConfig({ font_size: value });
          }
        }
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["app_title", config.app_title || defaultConfig.app_title],
        ["patient_list_title", config.patient_list_title || defaultConfig.patient_list_title],
        ["add_patient_button", config.add_patient_button || defaultConfig.add_patient_button]
      ]);
    }

    async function onConfigChange(config) {
      const app = document.getElementById('app');
      if (!app) return;

      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action || defaultConfig.primary_action;
      const secondaryColor = config.secondary_action || defaultConfig.secondary_action;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;

      app.style.backgroundColor = bgColor;
      app.style.color = textColor;
      app.style.fontFamily = `${fontFamily}, 'Segoe UI', sans-serif`;
      app.style.fontSize = `${fontSize}px`;

      const headers = app.querySelectorAll('h1, h2, h3, h4');
      headers.forEach(h => {
        h.style.color = textColor;
        h.style.fontFamily = `${fontFamily}, 'Segoe UI', sans-serif`;
        if (h.tagName === 'H1') h.style.fontSize = `${fontSize * 2}px`;
        if (h.tagName === 'H2') h.style.fontSize = `${fontSize * 1.5}px`;
        if (h.tagName === 'H3') h.style.fontSize = `${fontSize * 1.25}px`;
        if (h.tagName === 'H4') h.style.fontSize = `${fontSize * 1.1}px`;
      });

      const cards = app.querySelectorAll('.card, .surface');
      cards.forEach(card => {
        card.style.backgroundColor = surfaceColor;
        card.style.color = textColor;
      });

      const primaryButtons = app.querySelectorAll('.btn-primary');
      primaryButtons.forEach(btn => {
        btn.style.backgroundColor = primaryColor;
        btn.style.color = '#ffffff';
      });

      const secondaryButtons = app.querySelectorAll('.btn-secondary');
      secondaryButtons.forEach(btn => {
        btn.style.backgroundColor = secondaryColor;
        btn.style.color = '#ffffff';
      });

      const labels = app.querySelectorAll('label, .text-sm');
      labels.forEach(label => {
        label.style.color = textColor;
        label.style.fontSize = `${fontSize * 0.875}px`;
      });

      const appTitleEl = app.querySelector('#app-title');
      if (appTitleEl) {
        appTitleEl.textContent = config.app_title || defaultConfig.app_title;
      }

      const patientListTitleEl = app.querySelector('#patient-list-title');
      if (patientListTitleEl) {
        patientListTitleEl.textContent = config.patient_list_title || defaultConfig.patient_list_title;
      }

      const addPatientBtnEl = app.querySelector('#add-patient-btn');
      if (addPatientBtnEl) {
        addPatientBtnEl.textContent = config.add_patient_button || defaultConfig.add_patient_button;
      }
    }

    function initProvinceDropdown() {
      const provinceSelect = document.getElementById('province');
      if (!provinceSelect) return;

      provinceSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>';
      
      if (isLoadingAddressData) {
        provinceSelect.innerHTML = '<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</option>';
        return;
      }

      const provinces = Object.keys(thailandData).sort((a, b) => a.localeCompare(b, 'th'));
      provinces.forEach(province => {
        const option = document.createElement('option');
        option.value = province;
        option.textContent = province;
        provinceSelect.appendChild(option);
      });
    }

    function updateDistricts() {
      const provinceSelect = document.getElementById('province');
      const districtSelect = document.getElementById('district');
      const subdistrictSelect = document.getElementById('subdistrict');
      
      if (!provinceSelect || !districtSelect || !subdistrictSelect) return;

      districtSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>';
      subdistrictSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';

      const province = provinceSelect.value;
      if (!province || !thailandData[province]) return;

      const districts = Object.keys(thailandData[province]).sort((a, b) => a.localeCompare(b, 'th'));
      districts.forEach(district => {
        const option = document.createElement('option');
        option.value = district;
        option.textContent = district;
        districtSelect.appendChild(option);
      });
    }

    function updateSubdistricts() {
      const provinceSelect = document.getElementById('province');
      const districtSelect = document.getElementById('district');
      const subdistrictSelect = document.getElementById('subdistrict');
      
      if (!provinceSelect || !districtSelect || !subdistrictSelect) return;

      subdistrictSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';

      const province = provinceSelect.value;
      const district = districtSelect.value;
      if (!province || !district || !thailandData[province] || !thailandData[province][district]) return;

      const subdistricts = thailandData[province][district];
      subdistricts.forEach(subdistrict => {
        const option = document.createElement('option');
        option.value = subdistrict;
        option.textContent = subdistrict;
        subdistrictSelect.appendChild(option);
      });
    }

    function setAddressFields(patient) {
      if (!patient) return;

      setTimeout(() => {
        const provinceSelect = document.getElementById('province');
        const districtSelect = document.getElementById('district');
        const subdistrictSelect = document.getElementById('subdistrict');
        const houseNumberInput = document.getElementById('houseNumber');
        const mooInput = document.getElementById('moo');

        if (houseNumberInput && patient.houseNumber) {
          houseNumberInput.value = patient.houseNumber;
        }
        if (mooInput && patient.moo) {
          mooInput.value = patient.moo;
        }

        if (provinceSelect && patient.province) {
          provinceSelect.value = patient.province;
          updateDistricts();
          
          setTimeout(() => {
            if (districtSelect && patient.district) {
              districtSelect.value = patient.district;
              updateSubdistricts();
              
              setTimeout(() => {
                if (subdistrictSelect && patient.subdistrict) {
                  subdistrictSelect.value = patient.subdistrict;
                }
              }, 50);
            }
          }, 50);
        }
      }, 100);
    }

    function render() {
      const app = document.getElementById('app');
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;

      if (currentView === 'list') {
        app.innerHTML = renderPatientList();
      } else if (currentView === 'patient-detail') {
        app.innerHTML = renderPatientDetail();
      } else if (currentView === 'add-patient') {
        app.innerHTML = renderPatientForm('add');
        initProvinceDropdown();
      } else if (currentView === 'edit-patient') {
        app.innerHTML = renderPatientForm('edit');
        initProvinceDropdown();
        const patient = allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId);
        setAddressFields(patient);
      } else if (currentView === 'add-assessment') {
        app.innerHTML = renderAssessmentForm('add');
      } else if (currentView === 'edit-assessment') {
        app.innerHTML = renderAssessmentForm('edit');
      }

      onConfigChange(config);
    }

    function getFullAddress(patient) {
      const parts = [];
      if (patient.houseNumber) parts.push(patient.houseNumber);
      if (patient.moo) parts.push(`‡∏´‡∏°‡∏π‡πà ${patient.moo}`);
      if (patient.subdistrict) parts.push(`‡∏ï.${patient.subdistrict}`);
      if (patient.district) parts.push(`‡∏≠.${patient.district}`);
      if (patient.province) parts.push(`‡∏à.${patient.province}`);
      return parts.length > 0 ? parts.join(' ') : '-';
    }

    function renderPatientList() {
      const patients = allData.filter(d => d.type === 'patient');
      
      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-8">
              <h1 id="app-title" class="text-4xl font-bold">${defaultConfig.app_title}</h1>
              <button id="add-patient-btn" onclick="showAddPatient()" class="btn-primary px-6 py-3 rounded-lg font-semibold transition-all">
                ${defaultConfig.add_patient_button}
              </button>
            </div>

            <div class="surface rounded-xl shadow-lg p-6">
              <h2 id="patient-list-title" class="text-2xl font-semibold mb-6">${defaultConfig.patient_list_title}</h2>
              
              ${patients.length === 0 ? `
                <div class="text-center py-12">
                  <p class="text-xl opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•ÔøΩÔøΩ‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
                  <p class="mt-2 opacity-50">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</p>
                </div>
              ` : `
                <div class="space-y-4">
                  ${patients.map(patient => `
                    <div class="card card-hover p-5 rounded-lg border-2 border-gray-200 cursor-pointer transition-all" onclick="showPatientDetail('${patient.patientId}')">
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <h3 class="text-xl font-semibold mb-3">${patient.firstName} ${patient.lastName}</h3>
                          <div class="grid grid-cols-3 gap-x-6 gap-y-2 text-sm opacity-75">
                            <p><strong>HN:</strong> ${patient.hn}</p>
                            <p><strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${patient.age} ‡∏õÔøΩÔøΩ</p>
                            <p><strong>‡πÄ‡∏ûÔøΩÔøΩ:</strong> ${patient.gender}</p>
                            <p><strong>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</strong> ${patient.medicalRights || '-'}</p>
                            <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${patient.phoneNumber || '-'}</p>
                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤ IMC:</strong> ${formatThaiDate(patient.imcAdmitDate)}</p>
                          </div>
                          <p class="mt-3 text-sm"><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${getFullAddress(patient)}</p>
                          ${patient.diagnosisDetails ? `<p class="mt-2 text-sm"><strong>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢:</strong> ${patient.diagnosisDetails}</p>` : ''}
                        </div>
                        <div class="flex gap-2 ml-4">
                          <button onclick="event.stopPropagation(); showEditPatient('${patient.patientId}')" class="btn-secondary px-4 py-2 rounded text-sm font-semibold">
                            ‡πÅ‡∏ÅÔøΩÔøΩÔøΩ‡πÑ‡∏Ç
                          </button>
                          <button onclick="event.stopPropagation(); deletePatient('${patient.patientId}')" class="bg-red-500 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-red-600">
                            ‡∏•‡∏ö
                          </button>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderPatientDetail() {
      const patient = allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId);
      if (!patient) {
        currentView = 'list';
        render();
        return '';
      }

      const assessments = allData.filter(d => d.type === 'assessment' && d.patientId === selectedPatientId)
        .sort((a, b) => new Date(b.assessmentDate) - new Date(a.assessmentDate));

      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-7xl mx-auto">
            <button onclick="backToList()" class="btn-secondary px-4 py-2 rounded-lg mb-6 font-semibold">
              ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ÔøΩÔøΩ‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
            </button>

            <div class="surface rounded-xl shadow-lg p-6 mb-6">
              <div class="flex justify-between items-start mb-6">
                <h2 class="text-3xl font-bold">${patient.firstName} ${patient.lastName}</h2>
                <button onclick="showEditPatient('${patient.patientId}')" class="btn-secondary px-5 py-2 rounded-lg font-semibold">
                  ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
              </div>

              <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
              <h4 class="text-lg font-semibold mb-3 text-blue-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h4>
              <div class="grid grid-cols-3 gap-x-8 gap-y-3 mb-4">
                <p><strong>HN:</strong> ${patient.hn}</p>
                <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> ${patient.nationalId || '-'}</p>
                <p><strong>‡πÄ‡∏û‡∏®:</strong> ${patient.gender}</p>
                <p><strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${patient.age} ‡∏õ‡∏µ</p>
                <p><strong>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</strong> ${patient.medicalRights || '-'}</p>
                <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> ${patient.phoneNumber || '-'}</p>
                <p class="col-span-3"><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${getFullAddress(patient)}</p>
              </div>
              
              ${patient.gpsCoordinates ? `
                <div class="mb-4">
                  <p class="font-semibold mb-2">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${patient.gpsCoordinates}</p>
                  <div class="rounded-lg overflow-hidden">
                    <iframe src="https://maps.google.com/maps?q=${patient.gpsCoordinates}&z=15&output=embed" 
                      width="100%" height="300" frameborder="0" style="border:0" allowfullscreen></iframe>
                  </div>
                </div>
              ` : ''}

              <div class="section-divider"></div>

              <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢ -->
              <h4 class="text-lg font-semibold mb-3 text-blue-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢</h4>
              <div class="grid grid-cols-2 gap-x-8 gap-y-3 mb-4">
                <p><strong>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</strong> ${patient.underlyingDiseases || '-'}</p>
                <p><strong>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±ÔøΩÔøΩÔøΩ‡πÇ‡∏£‡∏Ñ:</strong> ${patient.diagnosisDetails || '-'}</p>
                <p><strong>ÔøΩÔøΩ‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô:</strong> ${formatThaiDate(patient.onsetDate) || '-'}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Admit:</strong> ${formatThaiDate(patient.admitDate) || '-'}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤ IMC:</strong> ${formatThaiDate(patient.imcAdmitDate)}</p>
                <p><strong>‡∏ß‡∏±ÔøΩÔøΩ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢:</strong> ${formatThaiDate(patient.dischargeDate) || '-'}</p>
              </div>
              
              ${patient.labResults ? `
                <div class="mb-3">
                  <p class="font-semibold mb-1">‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£:</p>
                  <p class="text-sm bg-gray-50 p-3 rounded">${patient.labResults}</p>
                </div>
              ` : ''}

              ${patient.additionalNotes ? `
                <div>
                  <p class="font-semibold mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</p>
                  <p class="text-sm bg-gray-50 p-3 rounded">${patient.additionalNotes}</p>
                </div>
              ` : ''}
            </div>

            <div class="surface rounded-xl shadow-lg p-6">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±ÔøΩÔøΩÔøΩ‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•</h3>
                <button onclick="showAddAssessment()" class="btn-primary px-6 py-3 rounded-lg font-semibold">
                  + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                </button>
              </div>

              ${assessments.length === 0 ? `
                <div class="text-center py-12">
                  <p class="text-xl opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•</p>
                  <p class="mt-2 opacity-50">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
                </div>
              ` : `
                <div class="space-y-4">
                  ${assessments.map(assessment => `
                    <div class="card p-5 rounded-lg border-2 border-gray-200">
                      <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                          <p class="text-lg font-semibold mb-3">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: ${formatThaiDate(assessment.assessmentDate)}</p>
                          <div class="grid grid-cols-1 gap-4">
                            <div class="bg-blue-50 p-3 rounded">
                              <p class="font-semibold text-sm opacity-75 mb-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô BI (Barthel Index):</p>
                              <p class="text-2xl font-bold text-blue-600">${assessment.biScore} / 100</p>
                              ${assessment.biDetails ? `<p class="text-sm mt-2">${assessment.biDetails}</p>` : ''}
                            </div>
                            <div>
                              <p class="font-semibold text-sm opacity-75 mb-1">PT Assessment:</p>
                              <p class="text-sm whitespace-pre-line">${assessment.ptAssessment || '-'}</p>
                            </div>
                            <div>
                              <p class="font-semibold text-sm opacity-75 mb-1">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤:</p>
                              <p class="text-sm whitespace-pre-line">${assessment.ptGoals || '-'}</p>
                            </div>
                            ${assessment.notes ? `
                              <div>
                                <p class="font-semibold text-sm opacity-75 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</p>
                                <p class="text-sm whitespace-pre-line bg-yellow-50 p-2 rounded">${assessment.notes}</p>
                              </div>
                            ` : ''}
                          </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                          <button onclick="showEditAssessment('${assessment.__backendId}')" class="btn-secondary px-4 py-2 rounded text-sm font-semibold">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                          </button>
                          <button onclick="deleteAssessment('${assessment.__backendId}')" class="bg-red-500 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-red-600">
                            ‡∏•‡∏ö
                          </button>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderPatientForm(mode) {
      const isEdit = mode === 'edit';
      const patient = isEdit ? allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId) : null;

      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-5xl mx-auto">
            <button onclick="${isEdit ? `showPatientDetail('${selectedPatientId}')` : 'backToList()'}" class="btn-secondary px-4 py-2 rounded-lg mb-6 font-semibold">
              ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            </button>

            <div class="surface rounded-xl shadow-lg p-8">
              <h2 class="text-3xl font-bold mb-8">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà'}</h2>

              <form id="patient-form" onsubmit="savePatient(event, '${mode}')">
                
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
                <h3 class="text-xl font-semibold mb-4 text-blue-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                <div class="space-y-4 mb-6">
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label for="firstName" class="block font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠ *</label>
                      <input type="text" id="firstName" name="firstName" value="${isEdit ? patient.firstName : ''}" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="lastName" class="block font-semibold mb-2">‡∏™‡∏Å‡∏∏‡∏• *</label>
                      <input type="text" id="lastName" name="lastName" value="${isEdit ? patient.lastName : ''}" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div class="grid grid-cols-3 gap-4">
                    <div>
                      <label for="hn" class="block font-semibold mb-2">HN *</label>
                      <input type="text" id="hn" name="hn" value="${isEdit ? patient.hn : ''}" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="nationalId" class="block font-semibold mb-2">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                      <input type="text" id="nationalId" name="nationalId" value="${isEdit ? patient.nationalId || '' : ''}" maxlength="13"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="gender" class="block font-semibold mb-2">‡πÄ‡∏û‡∏® *</label>
                      <select id="gender" name="gender" required 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®</option>
                        <option value="‡∏ä‡∏≤‡∏¢" ${isEdit && patient.gender === '‡∏ä‡∏≤‡∏¢' ? 'selected' : ''}>‡∏ä‡∏≤‡∏¢</option>
                        <option value="‡∏´‡∏ç‡∏¥‡∏á" ${isEdit && patient.gender === '‡∏´‡∏ç‡∏¥‡∏á' ? 'selected' : ''}>‡∏´‡∏ç‡∏¥‡∏á</option>
                      </select>
                    </div>
                  </div>

                  <div class="grid grid-cols-3 gap-4">
                    <div>
                      <label for="age" class="block font-semibold mb-2">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ) *</label>
                      <input type="number" id="age" name="age" value="${isEdit ? patient.age : ''}" required min="0" max="150"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="phoneNumber" class="block font-semibold mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                      <input type="tel" id="phoneNumber" name="phoneNumber" value="${isEdit ? patient.phoneNumber || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="medicalRights" class="block font-semibold mb-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                      <input type="text" id="medicalRights" name="medicalRights" value="${isEdit ? patient.medicalRights || '' : ''}"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div>
                    <label class="block font-semibold mb-3">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                    <div class="space-y-3">
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <label for="houseNumber" class="block text-sm font-semibold mb-1">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏ã‡∏≠‡∏¢ / ‡∏ñ‡∏ô‡∏ô</label>
                          <input type="text" id="houseNumber" name="houseNumber" 
                            value="${isEdit ? patient.houseNumber || '' : ''}"
                            placeholder="ÔøΩÔøΩ‡∏ä‡πà‡∏ô 123 ‡∏ã‡∏≠‡∏¢‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó 21"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                          <label for="moo" class="block text-sm font-semibold mb-1">‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</label>
                          <input type="text" id="moo" name="moo" 
                            value="${isEdit ? patient.moo || '' : ''}"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô 5"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                      </div>
                      <div class="grid grid-cols-3 gap-4">
                        <div>
                          <label for="province" class="block text-sm font-semibold mb-1">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                          <select id="province" name="province" onchange="updateDistricts()"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                          </select>
                        </div>
                        <div>
                          <label for="district" class="block text-sm font-semibold mb-1">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
                          <select id="district" name="district" onchange="updateSubdistricts()"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
                          </select>
                        </div>
                        <div>
                          <label for="subdistrict" class="block text-sm font-semibold mb-1">‡∏ï‡∏≥‡∏öÔøΩÔøΩ</label>
                          <select id="subdistrict" name="subdistrict"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div>
                    <label for="gpsCoordinates" class="block font-semibold mb-2">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                    <input type="text" id="gpsCoordinates" name="gpsCoordinates" value="${isEdit ? patient.gpsCoordinates || '' : ''}"
                      placeholder="‡πÄ‡∏ä‡πà‡∏ô 13.7563, 100.5018"
                      oninput="updateMap()"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    <div id="map-preview" class="mt-2 rounded-lg overflow-hidden" style="display: none;">
                      <iframe id="map-iframe" width="100%" height="300" frameborder="0" style="border:0" allowfullscreen></iframe>
                    </div>
                  </div>
                </div>

                <div class="section-divider"></div>

                <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢ -->
                <h3 class="text-xl font-semibold mb-4 text-blue-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢</h3>
                <div class="space-y-4 mb-6">
                  <div>
                    <label class="block font-semibold mb-3">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                    <div class="grid grid-cols-3 gap-4">
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="HT" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('HT') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>HT (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="DM" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('DM') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>DM (‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="DLP" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('DLP') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>DLP (‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="CKD" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('CKD') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>CKD (‡πÑ‡∏ï‡∏ß‡∏≤‡∏¢)</span>
                      </label>
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="disease" value="Heart disease" ${isEdit && patient.underlyingDiseases && patient.underlyingDiseases.includes('Heart disease') ? 'checked' : ''}
                          class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                        <span>Heart disease (‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à)</span>
                      </label>
                    </div>
                    <div class="mt-3">
                      <label for="otherDiseases" class="block text-sm font-semibold mb-1">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</label>
                      <input type="text" id="otherDiseases" name="otherDiseases" 
                        value="${isEdit && patient.underlyingDiseases ? patient.underlyingDiseases.split(',').filter(d => !['HT', 'DM', 'DLP', 'CKD', 'Heart disease'].includes(d.trim())).join(', ') : ''}"
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏Ñ‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div>
                    <label class="block font-semibold mb-3">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ</label>
                    <div class="space-y-4">
                      <!-- Stroke -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer mb-3">
                          <input type="checkbox" id="diagnosis-stroke" name="diagnosis" value="Stroke" 
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Stroke') ? 'checked' : ''}
                            onchange="toggleStrokeDetails(this.checked)"
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">Stroke</span>
                        </label>
                        <div id="stroke-details" class="ml-7 space-y-2" style="display: ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Stroke') ? 'block' : 'none'}">
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="stroke_type" value="Ischemic stroke"
                              ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Ischemic stroke') ? 'checked' : ''}
                              class="w-4 h-4">
                            <span class="text-sm">Ischemic stroke</span>
                          </label>
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="stroke_type" value="Hemorrhagic stroke"
                              ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Hemorrhagic stroke') ? 'checked' : ''}
                              class="w-4 h-4">
                            <span class="text-sm">Hemorrhagic stroke</span>
                          </label>
                        </div>
                      </div>

                      <!-- TBI -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" name="diagnosis" value="TBI"
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('TBI') ? 'checked' : ''}
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">TBI (Traumatic Brain Injury)</span>
                        </label>
                      </div>

                      <!-- SCI -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                          <input type="checkbox" name="diagnosis" value="SCI"
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('SCI') ? 'checked' : ''}
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">SCI (Spinal Cord Injury)</span>
                        </label>
                      </div>

                      <!-- Hip fracture -->
                      <div class="border-2 border-gray-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer mb-3">
                          <input type="checkbox" id="diagnosis-hip" name="diagnosis" value="Hip fracture"
                            ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Hip fracture') ? 'checked' : ''}
                            onchange="toggleHipDetails(this.checked)"
                            class="w-5 h-5 rounded border-gray-300 focus:ring-2">
                          <span class="font-semibold">Hip fracture</span>
                        </label>
                        <div id="hip-details" class="ml-7 space-y-3" style="display: ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Hip fracture') ? 'block' : 'none'}">
                          <div>
                            <p class="text-sm font-semibold mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</p>
                            <div class="space-y-2">
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_location" value="Neck of femur"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Neck of femur') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Neck of femur</span>
                              </label>
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_location" value="Intertrochanter"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Intertrochanter') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Intertrochanter</span>
                              </label>
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_location" value="Subtrochanter"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Subtrochanter') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Subtrochanter</span>
                              </label>
                            </div>
                          </div>
                          <div>
                            <p class="text-sm font-semibold mb-2">‡∏Ç‡πâ‡∏≤‡∏á:</p>
                            <div class="flex gap-4">
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_side" value="Lt"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Lt') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Lt. (‡∏ã‡πâ‡∏≤‡∏¢)</span>
                              </label>
                              <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="hip_side" value="Rt"
                                  ${isEdit && patient.diagnosisDetails && patient.diagnosisDetails.includes('Rt') ? 'checked' : ''}
                                  class="w-4 h-4">
                                <span class="text-sm">Rt. (‡∏Ç‡∏ß‡∏≤)</span>
                              </label>
                            </div>
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label for="onsetDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô</label>
                      <input type="date" id="onsetDate" name="onsetDate" value="${isEdit ? patient.onsetDate || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="admitDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Admit</label>
                      <input type="date" id="admitDate" name="admitDate" value="${isEdit ? patient.admitDate || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label for="imcAdmitDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤ IMC *</label>
                      <input type="date" id="imcAdmitDate" name="imcAdmitDate" value="${isEdit ? patient.imcAdmitDate : ''}" required
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                      <label for="dischargeDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô</label>
                      <input type="date" id="dischargeDate" name="dischargeDate" value="${isEdit ? patient.dischargeDate || '' : ''}"
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                  </div>

                  <div>
                    <label for="labResults" class="block font-semibold mb-2">‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</label>
                    <textarea id="labResults" name="labResults" rows="3" 
                      placeholder="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? patient.labResults || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="additionalNotes" class="block font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="additionalNotes" name="additionalNotes" rows="3" 
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? patient.additionalNotes || '' : ''}</textarea>
                  </div>
                </div>

                <div class="flex justify-end gap-4 mt-8">
                  <button type="button" onclick="${isEdit ? `showPatientDetail('${selectedPatientId}')` : 'backToList()'}" 
                    class="btn-secondary px-6 py-3 rounded-lg font-semibold">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                  </button>
                  <button type="submit" id="submit-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                    <span id="submit-text">${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'}</span>
                    <span id="submit-spinner" class="loading-spinner hidden"></span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    function renderAssessmentForm(mode) {
      const isEdit = mode === 'edit';
      const assessment = isEdit ? allData.find(d => d.__backendId === editingRecord) : null;

      return `
        <div class="w-full min-h-full p-6">
          <div class="max-w-4xl mx-auto">
            <button onclick="showPatientDetail('${selectedPatientId}')" class="btn-secondary px-4 py-2 rounded-lg mb-6 font-semibold">
              ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            </button>

            <div class="surface rounded-xl shadow-lg p-8">
              <h2 class="text-3xl font-bold mb-6">${isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà'}</h2>

              <form id="assessment-form" onsubmit="saveAssessment(event, '${mode}')">
                <div class="space-y-4">
                  <div>
                    <label for="assessmentDate" class="block font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô *</label>
                    <input type="date" id="assessmentDate" name="assessmentDate" 
                      value="${isEdit ? assessment.assessmentDate : ''}" required 
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                  </div>

                  <div>
                    <label for="biScore" class="block font-semibold mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô BI (Barthel Index) * (0-100)</label>
                    <input type="number" id="biScore" name="biScore" min="0" max="100" 
                      value="${isEdit ? assessment.biScore : ''}" required 
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                  </div>

                  <div>
                    <label for="biDetails" class="block font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î BI</label>
                    <textarea id="biDetails" name="biDetails" rows="3" 
                      placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.biDetails || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="ptAssessment" class="block font-semibold mb-2">PT Assessment</label>
                    <textarea id="ptAssessment" name="ptAssessment" rows="4" 
                      placeholder="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.ptAssessment || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="ptGoals" class="block font-semibold mb-2">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                    <textarea id="ptGoals" name="ptGoals" rows="3" 
                      placeholder="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.ptGoals || '' : ''}</textarea>
                  </div>

                  <div>
                    <label for="notes" class="block font-semibold mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="notes" name="notes" rows="3" 
                      placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">${isEdit ? assessment.notes || '' : ''}</textarea>
                  </div>

                  <div class="flex justify-end gap-4 mt-8">
                    <button type="button" onclick="showPatientDetail('${selectedPatientId}')" 
                      class="btn-secondary px-6 py-3 rounded-lg font-semibold">
                      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" id="submit-btn" class="btn-primary px-6 py-3 rounded-lg font-semibold flex items-center gap-2">
                      <span id="submit-text">${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞ÔøΩÔøΩÔøΩ‡∏°‡∏¥‡∏ô'}</span>
                      <span id="submit-spinner" class="loading-spinner hidden"></span>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    function toggleStrokeDetails(checked) {
      const strokeDetails = document.getElementById('stroke-details');
      if (strokeDetails) {
        strokeDetails.style.display = checked ? 'block' : 'none';
      }
    }

    function toggleHipDetails(checked) {
      const hipDetails = document.getElementById('hip-details');
      if (hipDetails) {
        hipDetails.style.display = checked ? 'block' : 'none';
      }
    }

    function updateMap() {
      const gpsInput = document.getElementById('gpsCoordinates');
      const mapPreview = document.getElementById('map-preview');
      const mapIframe = document.getElementById('map-iframe');
      
      if (!gpsInput || !mapPreview || !mapIframe) return;
      
      const coords = gpsInput.value.trim();
      if (coords && coords.includes(',')) {
        const [lat, lng] = coords.split(',').map(c => c.trim());
        if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
          mapIframe.src = `https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed`;
          mapPreview.style.display = 'block';
        } else {
          mapPreview.style.display = 'none';
        }
      } else {
        mapPreview.style.display = 'none';
      }
    }
    
    setTimeout(() => {
      updateMap();
    }, 100);

    function showAddPatient() {
      if (allData.filter(d => d.type === 'patient').length >= 999) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢');
        return;
      }
      currentView = 'add-patient';
      render();
    }

    function showEditPatient(patientId) {
      selectedPatientId = patientId;
      currentView = 'edit-patient';
      render();
    }

    function showPatientDetail(patientId) {
      selectedPatientId = patientId;
      currentView = 'patient-detail';
      render();
    }

    function showAddAssessment() {
      if (allData.length >= 999) {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return;
      }
      currentView = 'add-assessment';
      render();
    }

    function showEditAssessment(backendId) {
      editingRecord = backendId;
      currentView = 'edit-assessment';
      render();
    }

    function backToList() {
      selectedPatientId = null;
      currentView = 'list';
      render();
    }

    async function savePatient(event, mode) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');
      
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-disabled');
      submitText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      submitSpinner.classList.remove('hidden');

      const formData = new FormData(event.target);
      
      // ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß
      const diseases = [];
      const diseaseCheckboxes = event.target.querySelectorAll('input[name="disease"]:checked');
      diseaseCheckboxes.forEach(cb => diseases.push(cb.value));
      const otherDiseases = formData.get('otherDiseases');
      if (otherDiseases && otherDiseases.trim()) {
        diseases.push(otherDiseases.trim());
      }
      
      // ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ
      const diagnosisParts = [];
      const diagnosisCheckboxes = event.target.querySelectorAll('input[name="diagnosis"]:checked');
      diagnosisCheckboxes.forEach(cb => {
        const value = cb.value;
        diagnosisParts.push(value);
        
        if (value === 'Stroke') {
          const strokeType = event.target.querySelector('input[name="stroke_type"]:checked');
          if (strokeType) {
            diagnosisParts.push(strokeType.value);
          }
        }
        
        if (value === 'Hip fracture') {
          const hipLocation = event.target.querySelector('input[name="hip_location"]:checked');
          if (hipLocation) {
            diagnosisParts.push(hipLocation.value);
          }
          const hipSide = event.target.querySelector('input[name="hip_side"]:checked');
          if (hipSide) {
            diagnosisParts.push(hipSide.value);
          }
        }
      });
      
      const patientData = {
        type: 'patient',
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        hn: formData.get('hn'),
        nationalId: formData.get('nationalId') || null,
        birthDate: null,
        age: parseInt(formData.get('age')),
        gender: formData.get('gender'),
        medicalRights: formData.get('medicalRights') || null,
        houseNumber: formData.get('houseNumber') || null,
        moo: formData.get('moo') || null,
        subdistrict: formData.get('subdistrict') || null,
        district: formData.get('district') || null,
        province: formData.get('province') || null,
        gpsCoordinates: formData.get('gpsCoordinates') || null,
        phoneNumber: formData.get('phoneNumber') || null,
        underlyingDiseases: diseases.length > 0 ? diseases.join(', ') : null,
        diagnosisDetails: diagnosisParts.length > 0 ? diagnosisParts.join(' | ') : null,
        onsetDate: formData.get('onsetDate') || null,
        admitDate: formData.get('admitDate') || null,
        imcAdmitDate: formData.get('imcAdmitDate'),
        dischargeDate: formData.get('dischargeDate') || null,
        labResults: formData.get('labResults') || null,
        additionalNotes: formData.get('additionalNotes') || null,
        createdAt: new Date().toISOString()
      };

      let result;
      if (mode === 'add') {
        if (allData.filter(d => d.type === 'patient').length >= 999) {
          showToast('‡πÑÔøΩÔøΩ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢');
          submitBtn.disabled = false;
          submitBtn.classList.remove('btn-disabled');
          submitText.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢';
          submitSpinner.classList.add('hidden');
          return;
        }
        patientData.patientId = 'P' + Date.now();
        result = await window.dataSdk.create(patientData);
      } else {
        const existing = allData.find(d => d.type === 'patient' && d.patientId === selectedPatientId);
        result = await window.dataSdk.update({ ...existing, ...patientData });
      }

      submitBtn.disabled = false;
      submitBtn.classList.remove('btn-disabled');
      submitSpinner.classList.add('hidden');

      if (result.isOk) {
        showToast(mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ÇÔøΩÔøΩ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        if (mode === 'add') {
          backToList();
        } else {
          showPatientDetail(selectedPatientId);
        }
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
        submitText.textContent = mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢' : '‡∏ö‡∏±‡∏ôÔøΩÔøΩÔøΩ‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
      }
    }

    async function saveAssessment(event, mode) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');
      
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-disabled');
      submitText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      submitSpinner.classList.remove('hidden');

      const formData = new FormData(event.target);
      const assessmentData = {
        type: 'assessment',
        patientId: selectedPatientId,
        assessmentDate: formData.get('assessmentDate'),
        biScore: parseInt(formData.get('biScore')),
        biDetails: formData.get('biDetails') || null,
        ptAssessment: formData.get('ptAssessment') || null,
        ptGoals: formData.get('ptGoals') || null,
        notes: formData.get('notes') || null,
        createdAt: new Date().toISOString()
      };

      let result;
      if (mode === 'add') {
        if (allData.length >= 999) {
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 999 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
          submitBtn.disabled = false;
          submitBtn.classList.remove('btn-disabled');
          submitText.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô';
          submitSpinner.classList.add('hidden');
          return;
        }
        result = await window.dataSdk.create(assessmentData);
      } else {
        const existing = allData.find(d => d.__backendId === editingRecord);
        result = await window.dataSdk.update({ ...existing, ...assessmentData });
      }

      submitBtn.disabled = false;
      submitBtn.classList.remove('btn-disabled');
      submitSpinner.classList.add('hidden');

      if (result.isOk) {
        showToast(mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        showPatientDetail(selectedPatientId);
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
        submitText.textContent = mode === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
      }
    }

    async function deletePatient(patientId) {
      const patient = allData.find(d => d.type === 'patient' && d.patientId === patientId);
      if (!patient) return;

      const assessments = allData.filter(d => d.type === 'assessment' && d.patientId === patientId);
      
      const confirmEl = document.createElement('div');
      confirmEl.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
      confirmEl.innerHTML = `
        <div class="surface rounded-xl shadow-2xl p-8 max-w-md mx-4">
          <h3 class="text-2xl font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
          <p class="mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ "${patient.firstName} ${patient.lastName}" ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${assessments.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
          <div class="flex gap-4 justify-end">
            <button id="cancel-delete" class="btn-secondary px-6 py-3 rounded-lg font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button id="confirm-delete" class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 flex items-center gap-2">
              <span id="delete-text">‡∏•‡∏ö</span>
              <span id="delete-spinner" class="loading-spinner hidden"></span>
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmEl);

      document.getElementById('cancel-delete').onclick = () => {
        document.body.removeChild(confirmEl);
      };

      document.getElementById('confirm-delete').onclick = async () => {
        const deleteBtn = document.getElementById('confirm-delete');
        const deleteText = document.getElementById('delete-text');
        const deleteSpinner = document.getElementById('delete-spinner');
        
        deleteBtn.disabled = true;
        deleteBtn.classList.add('btn-disabled');
        deleteText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
        deleteSpinner.classList.remove('hidden');

        for (const assessment of assessments) {
          await window.dataSdk.delete(assessment);
        }
        
        const result = await window.dataSdk.delete(patient);
        
        if (result.isOk) {
          showToast('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          document.body.removeChild(confirmEl);
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
          deleteBtn.disabled = false;
          deleteBtn.classList.remove('btn-disabled');
          deleteText.textContent = '‡∏•‡∏ö';
          deleteSpinner.classList.add('hidden');
        }
      };
    }

    async function deleteAssessment(backendId) {
      const assessment = allData.find(d => d.__backendId === backendId);
      if (!assessment) return;

      const confirmEl = document.createElement('div');
      confirmEl.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50';
      confirmEl.innerHTML = `
        <div class="surface rounded-xl shadow-2xl p-8 max-w-md mx-4">
          <h3 class="text-2xl font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•ÔøΩÔøΩÔøΩ</h3>
          <p class="mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(assessment.assessmentDate)} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
          <div class="flex gap-4 justify-end">
            <button id="cancel-delete" class="btn-secondary px-6 py-3 rounded-lg font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button id="confirm-delete" class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 flex items-center gap-2">
              <span id="delete-text">‡∏•‡∏ö</span>
              <span id="delete-spinner" class="loading-spinner hidden"></span>
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmEl);

      document.getElementById('cancel-delete').onclick = () => {
        document.body.removeChild(confirmEl);
      };

      document.getElementById('confirm-delete').onclick = async () => {
        const deleteBtn = document.getElementById('confirm-delete');
        const deleteText = document.getElementById('delete-text');
        const deleteSpinner = document.getElementById('delete-spinner');
        
        deleteBtn.disabled = true;
        deleteBtn.classList.add('btn-disabled');
        deleteText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
        deleteSpinner.classList.remove('hidden');

        const result = await window.dataSdk.delete(assessment);
        
        if (result.isOk) {
          showToast('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          document.body.removeChild(confirmEl);
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error.message);
          deleteBtn.disabled = false;
          deleteBtn.classList.remove('btn-disabled');
          deleteText.textContent = '‡∏•‡∏ö';
          deleteSpinner.classList.add('hidden');
        }
      };
    }

    function formatThaiDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const thaiMonths = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
      return `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 surface px-6 py-4 rounded-lg shadow-xl z-50';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    window.onload = initApp;
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a38fffc532ef3fb',t:'MTc2Mzk4ODI5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
